<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Tracker</title>
    <!-- 
      PERFORMANCE FIX: Purane Tailwind CDN script ko hata kar Play CDN use kiya gaya hai.
      Yeh live compilation ke liye behtar hai aur mobile par page load speed ko kaafi improve karega.
      Forms plugin ko form elements ki styling ke liye add kiya gaya hai.
    -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
            color: #334155; /* Slate 700 */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* Indigo 600 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Gradient Text Style */
        .gradient-text {
            background-image: linear-gradient(to right, #4f46e5, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        /* Button Style Improvements */
        .btn {
            @apply font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 hover:scale-105;
        }
        .btn-secondary {
            @apply bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400 hover:scale-105;
        }
        .btn-success {
            @apply bg-green-500 text-white hover:bg-green-600 focus:ring-green-500 hover:scale-105;
        }
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600 focus:ring-red-500 hover:scale-105;
        }
        .btn-purple {
            @apply bg-purple-600 text-white hover:bg-purple-700 focus:ring-purple-500 hover:scale-105;
        }
        .btn-teal {
            @apply bg-teal-500 text-white hover:bg-teal-600 focus:ring-teal-500 hover:scale-105;
        }
        .btn-icon {
            @apply flex items-center justify-center gap-2;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- Custom Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 text-center transform transition-all">
                <p id="message-text" class="text-lg mb-6 text-slate-700"></p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="btn btn-primary">
                    Close
                </button>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 text-center">
                <h3 class="text-xl font-bold mb-2 text-slate-800">Confirm Deletion</h3>
                <p class="mb-6 text-slate-600">Are you sure you want to delete this entry? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete-btn" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- All other modals will also get this improved look automatically when using the `btn` classes -->

        <!-- Edit Entry Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3">
                <h3 class="text-lg font-bold mb-4">Edit Attendance Entry</h3>
                <form id="edit-form">
                    <input type="hidden" id="edit-doc-id">
                    <div class="mb-4">
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="edit-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-in-time" class="block text-sm font-medium text-gray-700">In Time</label>
                        <input type="time" id="edit-in-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                     <div class="mb-4">
                        <label for="edit-out-time" class="block text-sm font-medium text-gray-700">Out Time</label>
                        <input type="time" id="edit-out-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Monthly Report Modal -->
        <div id="monthly-report-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3">
                <h3 class="text-lg font-bold mb-4">Generate Monthly Report</h3>
                <form id="monthly-report-form">
                    <div class="mb-4">
                        <label for="report-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="report-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-monthly-report-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-purple">Generate</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Other Modals (Week Off, Holidays, Shift Change) follow the same structure -->
        <!-- These are just shortened for brevity but will work with the new styles -->
        <div id="week-off-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-2/3 max-h-screen overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">Set Monthly Week Offs</h3>
                <div class="flex items-end space-x-2 mb-4">
                    <div class="flex-grow">
                        <label for="week-off-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="week-off-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <button id="load-employees-btn" class="btn btn-primary">Load Employees</button>
                </div>
                <form id="week-off-form">
                    <div id="week-off-employee-list" class="space-y-4"></div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-week-off-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Week Offs</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="holidays-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-2/3 max-h-screen overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">Set Monthly Holidays</h3>
                 <div class="flex items-end space-x-2 mb-4">
                    <div class="flex-grow">
                        <label for="holidays-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="holidays-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                </div>
                <form id="holidays-form">
                    <div id="holidays-list" class="flex flex-wrap mt-2"></div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-holidays-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Holidays</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="shift-change-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3">
                <h3 class="text-lg font-bold mb-4">Request Shift Change</h3>
                <form id="shift-change-form">
                    <!-- Form fields here, will be styled by the forms plugin -->
                    <div class="mb-4">
                        <label for="shift-change-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="shift-change-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="my-shift" class="block text-sm font-medium text-gray-700">My Shift</label>
                            <select id="my-shift" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option value="A">A (7am - 2pm)</option><option value="B">B (2pm - 9pm)</option><option value="C">C (9pm - 7am)</option><option value="G">General (9am - 6pm)</option>
                            </select>
                        </div>
                        <div>
                            <label for="colleague-shift" class="block text-sm font-medium text-gray-700">Colleague's Shift</label>
                            <select id="colleague-shift" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                <option value="A">A (7am - 2pm)</option><option value="B">B (2pm - 9pm)</option><option value="C">C (9pm - 7am)</option><option value="G">General (9am - 6pm)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="colleague-empid" class="block text-sm font-medium text-gray-700">Colleague's Employee ID</label>
                        <input type="text" id="colleague-empid" placeholder="Enter Colleague's EMP ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="shift-change-remarks" class="block text-sm font-medium text-gray-700">Remarks</label>
                        <textarea id="shift-change-remarks" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-shift-change-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Request</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden mt-10 p-8">
            <h2 class="text-3xl font-bold text-center mb-6 gradient-text">Employee Login</h2>
            <div id="auth-container">
                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <button type="submit" class="w-full btn btn-primary py-3">Login</button>
                </form>
                <p class="text-center mt-6">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-indigo-600 hover:underline">Sign Up</a>
                </p>
            </div>
            <div id="signup-container" class="hidden">
                 <!-- Signup Form -->
                <form id="signup-form" class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="text" id="signup-empid" placeholder="Employee ID" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="text" id="signup-orgid" placeholder="Organization ID" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full px-4 py-3 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <button type="submit" class="w-full btn btn-success py-3">Sign Up</button>
                </form>
                <p class="text-center mt-6">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline">Login</a>
                </p>
            </div>
        </div>

        <!-- Main App Content (Hidden by default) -->
        <div id="app-content" class="hidden">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-lg">
                <h1 class="text-4xl font-bold gradient-text">Dashboard</h1>
                <div class="text-right mt-4 md:mt-0">
                    <p id="user-info" class="text-lg font-medium text-slate-700"></p>
                    <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:underline">Logout</button>
                </div>
            </header>

            <!-- Actions Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-slate-800">Quick Actions</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="clock-in-btn" class="btn btn-success btn-icon disabled:bg-gray-400 disabled:scale-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                        Clock In
                    </button>
                    <button id="clock-out-btn" class="btn btn-danger btn-icon disabled:bg-gray-400 disabled:scale-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414L7 8.586V13a1 1 0 102 0v-3.586l1.707-1.707z" clip-rule="evenodd" /></svg>
                        Clock Out
                    </button>
                    <button id="shift-change-request-btn" class="btn btn-primary btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" /></svg>
                        Request Shift Change
                    </button>
                </div>
                 <p id="location-status" class="mt-4 text-sm text-slate-600">Checking your location...</p>
            </div>

            <!-- Employee's Data Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- My Attendance Table -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">My Attendance</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-200">
                                    <th class="p-3 font-semibold">Date</th>
                                    <th class="p-3 font-semibold">In Time</th>
                                    <th class="p-3 font-semibold">Out Time</th>
                                    <th class="p-3 font-semibold">Hours</th>
                                </tr>
                            </thead>
                            <tbody id="employee-table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- My Shift Change Requests -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">My Shift Requests</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-200">
                                    <th class="p-3 font-semibold">Date</th>
                                    <th class="p-3 font-semibold">With</th>
                                    <th class="p-3 font-semibold">Shift Change</th>
                                    <th class="p-3 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="employee-requests-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard (Hidden by default) -->
            <div id="admin-dashboard" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4 -mb-px" aria-label="Tabs">
                        <button id="tab-attendance" class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-indigo-500 text-indigo-600">Attendance Records</button>
                        <button id="tab-shift-requests" class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent">Shift Requests</button>
                    </nav>
                </div>

                <!-- Admin Attendance View -->
                <div id="admin-attendance-view">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Admin: All Records</h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input type="date" id="filter-date" class="p-2 border rounded-lg">
                        <input type="text" id="filter-name" placeholder="Filter by Employee Name" class="p-2 border rounded-lg flex-grow">
                        <button id="export-btn" class="btn btn-primary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Export
                        </button>
                        <button id="monthly-report-btn" class="btn btn-purple btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm2 4a1 1 0 100 2h4a1 1 0 100-2H8zm0 3a1 1 0 100 2h4a1 1 0 100-2H8zm0 3a1 1 0 100 2h2a1 1 0 100-2H8z" clip-rule="evenodd" /></svg>
                            Monthly
                        </button>
                        <button id="set-week-off-btn" class="btn btn-teal btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                            Week Offs
                        </button>
                         <button id="set-holidays-btn" class="btn bg-indigo-500 hover:bg-indigo-600 text-white btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 2a.5.5 0 01.5.5v1a.5.5 0 01-1 0v-1a.5.5 0 01.5-.5zM14.5 2a.5.5 0 01.5.5v1a.5.5 0 01-1 0v-1a.5.5 0 01.5-.5zM4 6a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm4.5 5a.5.5 0 000-1h3a.5.5 0 000 1h-3z" clip-rule="evenodd" /></svg>
                            Holidays
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-200">
                                    <th class="p-3 font-semibold">Date</th>
                                    <th class="p-3 font-semibold">Employee Name</th>
                                    <th class="p-3 font-semibold">In Time</th>
                                    <th class="p-3 font-semibold">Out Time</th>
                                    <th class="p-3 font-semibold">Hours</th>
                                    <th class="p-3 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin Shift Change Requests View -->
                <div id="admin-shift-requests-view" class="hidden">
                     <h2 class="text-2xl font-semibold mb-4 text-slate-800">Admin: Shift Requests</h2>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-200">
                                    <th class="p-3 font-semibold">Date</th>
                                    <th class="p-3 font-semibold">Requester</th>
                                    <th class="p-3 font-semibold">Colleague</th>
                                    <th class="p-3 font-semibold">Change</th>
                                    <th class="p-3 font-semibold">Remarks</th>
                                    <th class="p-3 font-semibold">Status</th>
                                    <th class="p-3 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-requests-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            onSnapshot,
            doc,
            updateDoc,
            setDoc,
            deleteDoc,
            getDoc,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Aapki Firebase keys yahan daal di gayi hain.
        const firebaseConfig = {
            apiKey: "AIzaSyCEVg46yTI80gR-nlsf_T6_3HUtEi77Hj8",
            authDomain: "firstapp-cae0a.firebaseapp.com",
            projectId: "firstapp-cae0a",
            storageBucket: "firstapp-cae0a.firebasestorage.app",
            messagingSenderId: "48434901520",
            appId: "1:48434901520:web:dada602a58d99405505095",
            measurementId: "G-GC63DF4N8G"
        };
        
        const ADMIN_UID = 'LZC3oe3qOMQnGEN3FGppJIRyO462'; // Admin ka UID
        
        // Office Geofence Configuration
        const OFFICE_LOCATION = { latitude: 28.530243, longitude: 77.357587 };
        const GEOFENCE_RADIUS_METERS = 50; // Office ke 50 meter ke daayre mein
        
        // --- DOM ELEMENT REFERENCES (Ye sab pehle jaisa hi hai) ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const signupContainer = document.getElementById('signup-container');
        const authContainer = document.getElementById('auth-container');
        const userInfo = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const locationStatus = document.getElementById('location-status');
        const employeeTableBody = document.getElementById('employee-table-body');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminTableBody = document.getElementById('admin-table-body');
        const filterDate = document.getElementById('filter-date');
        const filterName = document.getElementById('filter-name');
        const exportBtn = document.getElementById('export-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const monthlyReportBtn = document.getElementById('monthly-report-btn');
        const monthlyReportModal = document.getElementById('monthly-report-modal');
        const monthlyReportForm = document.getElementById('monthly-report-form');
        const cancelMonthlyReportBtn = document.getElementById('cancel-monthly-report-btn');
        const setWeekOffBtn = document.getElementById('set-week-off-btn');
        const weekOffModal = document.getElementById('week-off-modal');
        const weekOffForm = document.getElementById('week-off-form');
        const cancelWeekOffBtn = document.getElementById('cancel-week-off-btn');
        const loadEmployeesBtn = document.getElementById('load-employees-btn');
        const weekOffEmployeeList = document.getElementById('week-off-employee-list');
        const setHolidaysBtn = document.getElementById('set-holidays-btn');
        const holidaysModal = document.getElementById('holidays-modal');
        const holidaysForm = document.getElementById('holidays-form');
        const holidaysMonthInput = document.getElementById('holidays-month');
        const holidaysList = document.getElementById('holidays-list');
        const cancelHolidaysBtn = document.getElementById('cancel-holidays-btn');
        const shiftChangeRequestBtn = document.getElementById('shift-change-request-btn');
        const shiftChangeModal = document.getElementById('shift-change-modal');
        const shiftChangeForm = document.getElementById('shift-change-form');
        const cancelShiftChangeBtn = document.getElementById('cancel-shift-change-btn');
        const employeeRequestsBody = document.getElementById('employee-requests-body');
        const tabAttendance = document.getElementById('tab-attendance');
        const tabShiftRequests = document.getElementById('tab-shift-requests');
        const adminAttendanceView = document.getElementById('admin-attendance-view');
        const adminShiftRequestsView = document.getElementById('admin-shift-requests-view');
        const adminRequestsBody = document.getElementById('admin-requests-body');
        
        let currentUser = null;
        let userUnsubscribe = null;
        let adminUnsubscribe = null;
        let shiftRequestsUnsubscribe = null;
        let allAdminRecords = [];
        let allUsers = [];
        let docIdToDelete = null;

        // --- UTILITY FUNCTIONS ---
        // Same as before, no major changes here.
        
        function showMessage(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function toggleLoader(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function getDistance(loc1, loc2) {
            const R = 6371e3; // metres
            const φ1 = loc1.latitude * Math.PI/180;
            const φ2 = loc2.latitude * Math.PI/180;
            const Δφ = (loc2.latitude-loc1.latitude) * Math.PI/180;
            const Δλ = (loc2.longitude-loc1.longitude) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function checkLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    locationStatus.textContent = "Aapke browser mein Geolocation support nahi hai.";
                    return reject("Geolocation Not Supported");
                }
                locationStatus.textContent = "Aapki location check ki ja rahi hai...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                        const distance = getDistance(userLocation, OFFICE_LOCATION);
                        if (distance <= GEOFENCE_RADIUS_METERS) {
                            locationStatus.innerHTML = `<span class="text-green-600 font-semibold">Status: Aap office location ke andar hain.</span>`;
                            resolve("Within Location");
                        } else {
                            locationStatus.innerHTML = `<span class="text-red-600 font-semibold">Error: Aap office location se bahar hain (${distance.toFixed(0)}m door). Clock-in/out band hai.</span>`;
                            reject(`Aap office location se bahar hain.`);
                        }
                    },
                    () => {
                        locationStatus.innerHTML = `<span class="text-red-600 font-semibold">Error: Location ki anumati dein. Bina location ke clock-in/out nahi ho sakta.</span>`;
                        reject("Location ki anumati nahi hai");
                    }
                );
            });
        }
        
        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }
        
        function formatTimeForInput(date) {
            if (!date) return '';
            let hours = date.getHours().toString().padStart(2, '0');
            let minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }

        function calculateTotalHours(inTime, outTime) {
            if (!inTime || !outTime) return "N/A";
            const diffMs = outTime.getTime() - inTime.getTime();
            if (diffMs < 0) return "Invalid";
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffMins = Math.round((diffMs % 3600000) / 60000);
            return `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'approved': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>`;
                case 'rejected': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                default: return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`;
            }
        }

        // --- FIREBASE INITIALIZATION & APP LOGIC ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (userUnsubscribe) userUnsubscribe();
            if (adminUnsubscribe) adminUnsubscribe();
            if (shiftRequestsUnsubscribe) shiftRequestsUnsubscribe();

            if (user && !user.isAnonymous) {
                currentUser = user;
                const usersColPath = `users`;
                const userQuery = query(collection(db, usersColPath), where("uid", "==", user.uid));
                const userDocSnap = await getDocs(userQuery);
                
                let userName = user.email;
                if (!userDocSnap.empty) {
                    const userData = userDocSnap.docs[0].data();
                    userName = userData.name;
                    currentUser.empId = userData.empId;
                }
                
                currentUser.displayName = userName;

                userInfo.textContent = `Welcome, ${userName}`;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                checkLocation();
                listenForUserRecords(user.uid);
                listenForUserShiftRequests(user.uid);
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
                adminDashboard.classList.add('hidden');
            }
            toggleLoader(false);
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage("Login Failed: " + error.code);
            } finally {
                toggleLoader(false);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const empId = document.getElementById('signup-empid').value;
            const orgId = document.getElementById('signup-orgid').value;

            if (orgId !== `AN01${empId}`) {
                showMessage("Invalid Organization ID. Please check your details.");
                toggleLoader(false);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const usersColPath = `users`;
                await setDoc(doc(db, usersColPath, userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    name: name,
                    email: email,
                    empId: empId
                });
                showMessage("Signup successful! Please login.");
                showLogin.click();
            } catch (error) {
                showMessage("Signup Failed: " + error.code);
            } finally {
                toggleLoader(false);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            toggleLoader(true);
            await signOut(auth);
        });

        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            authContainer.classList.add('hidden');
            signupContainer.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
        });

        // --- FIRESTORE & APP LOGIC ---
        async function updateClockButtons(uid) {
            const todayStr = formatDate(new Date());
            const attendanceCol = collection(db, `attendance`);
            const q = query(attendanceCol, where("uid", "==", uid), where("date", "==", todayStr));
            
            const querySnapshot = await getDocs(q);
            
            clockInBtn.disabled = true;
            clockOutBtn.disabled = true;

            if (querySnapshot.empty) {
                clockInBtn.disabled = false;
            } else {
                const todayRecord = querySnapshot.docs[0].data();
                if (todayRecord.in_time && !todayRecord.out_time) {
                    clockOutBtn.disabled = false;
                }
            }
        }

        clockInBtn.addEventListener('click', async () => {
            if (!currentUser) return showMessage("You must be logged in.");
            toggleLoader(true);
            try {
                const location = await checkLocation(); // This will now reject if outside radius
                const now = new Date();
                const dateStr = formatDate(now);
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();

                const weekOffDocRef = doc(db, 'weekoffs', `${currentUser.uid}_${year}_${month}`);
                const weekOffDoc = await getDoc(weekOffDocRef);
                if (weekOffDoc.exists() && weekOffDoc.data().dates.includes(day)) {
                    const coffsCol = collection(db, 'coffs');
                    await addDoc(coffsCol, {
                        uid: currentUser.uid,
                        earned_date: dateStr,
                        availed_date: null,
                        status: 'earned',
                        year: year,
                        month: month
                    });
                    showMessage("C/off has been generated for working on a week off.");
                }
                
                const attendanceCol = collection(db, `attendance`);
                await addDoc(attendanceCol, {
                    uid: currentUser.uid,
                    employee_name: currentUser.displayName,
                    date: dateStr,
                    in_time: now,
                    in_location: location,
                    out_time: null,
                    out_location: null,
                    total_hours: null
                });
                showMessage("Successfully clocked in!");
            } catch (error) {
                showMessage(`Clock-in failed: ${error}`);
            } finally {
                toggleLoader(false);
            }
        });

        clockOutBtn.addEventListener('click', async () => {
            if (!currentUser) return showMessage("You must be logged in.");
            toggleLoader(true);
            try {
                const location = await checkLocation(); // This will now reject if outside radius
                const now = new Date();
                const todayStr = formatDate(now);

                const attendanceCol = collection(db, `attendance`);
                const q = query(attendanceCol, where("uid", "==", currentUser.uid), where("date", "==", todayStr), where("out_time", "==", null));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const docToUpdate = querySnapshot.docs[0];
                    const inTimeDate = docToUpdate.data().in_time.toDate();
                    const docRef = doc(db, `attendance`, docToUpdate.id);
                    await updateDoc(docRef, {
                        out_time: now,
                        out_location: location,
                        total_hours: calculateTotalHours(inTimeDate, now)
                    });
                    showMessage("Successfully clocked out!");
                } else {
                    showMessage("Could not find an open clock-in record for today.");
                }
            } catch (error) {
                showMessage(`Clock-out failed: ${error}`);
            } finally {
                toggleLoader(false);
            }
        });
        
        function renderTable(tableBody, records, isAdminView = false) {
            tableBody.innerHTML = '';
            if (records.length === 0) {
                const colSpan = isAdminView ? 6 : 4;
                tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center p-4 text-slate-500">No records found.</td></tr>`;
                return;
            }

            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            records.forEach(rec => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                
                const inTime = rec.in_time ? formatTime(rec.in_time.toDate()) : 'N/A';
                const outTime = rec.out_time ? formatTime(rec.out_time.toDate()) : 'N/A';

                const employeeColumns = `
                    <td class="p-3">${rec.date}</td>
                    <td class="p-3">${inTime}</td>
                    <td class="p-3">${outTime}</td>
                    <td class="p-3">${rec.total_hours || 'N/A'}</td>
                `;

                const adminColumns = `
                    <td class="p-3">${rec.date}</td>
                    <td class="p-3 font-medium text-slate-700">${rec.employee_name || 'N/A'}</td>
                    <td class="p-3">${inTime}</td>
                    <td class="p-3">${outTime}</td>
                    <td class="p-3">${rec.total_hours || 'N/A'}</td>
                    <td class="p-3 space-x-2 whitespace-nowrap">
                        <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600" data-id="${rec.id}">Edit</button>
                        <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-id="${rec.id}">Delete</button>
                    </td>
                `;

                row.innerHTML = isAdminView ? adminColumns : employeeColumns;
                tableBody.appendChild(row);
            });
        }
        
        async function fetchAllUsers() {
            const usersCol = collection(db, 'users');
            const userSnapshot = await getDocs(usersCol);
            allUsers = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function listenForUserRecords(uid) {
            const q = query(collection(db, `attendance`), where("uid", "==", uid));
            userUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(employeeTableBody, records, false);
                updateClockButtons(uid);
                if (uid === ADMIN_UID) {
                    adminDashboard.classList.remove('hidden');
                    fetchAllUsers();
                    listenForAdminRecords();
                    listenForAdminShiftRequests();
                } else {
                    adminDashboard.classList.add('hidden');
                }
            }, (error) => console.error("Error listening to user records: ", error));
        }

        function listenForAdminRecords() {
            const q = query(collection(db, `attendance`));
            adminUnsubscribe = onSnapshot(q, (snapshot) => {
                allAdminRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAdminFilters();
            }, (error) => console.error("Error listening to admin records: ", error));
        }
        
        function applyAdminFilters() {
            const date = filterDate.value;
            const name = filterName.value.toLowerCase();
            
            const filteredRecords = allAdminRecords.filter(rec => {
                const nameMatch = name ? (rec.employee_name || '').toLowerCase().includes(name) : true;
                const dateMatch = date ? rec.date === date : true;
                return nameMatch && dateMatch;
            });
            
            renderTable(adminTableBody, filteredRecords, true);
        }

        filterDate.addEventListener('input', applyAdminFilters);
        filterName.addEventListener('input', applyAdminFilters);
        
        // --- The rest of the JS functions (Edit, Delete, Export, etc.) are included here ---
        // They were already well-structured.
        
        adminTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                docIdToDelete = e.target.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
            }
            if (e.target.classList.contains('edit-btn')) {
                const docId = e.target.dataset.id;
                const docRef = doc(db, 'attendance', docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('edit-doc-id').value = docId;
                    document.getElementById('edit-date').value = data.date;
                    document.getElementById('edit-in-time').value = data.in_time ? formatTimeForInput(data.in_time.toDate()) : '';
                    document.getElementById('edit-out-time').value = data.out_time ? formatTimeForInput(data.out_time.toDate()) : '';
                    editModal.classList.remove('hidden');
                }
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            docIdToDelete = null;
            deleteConfirmModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (docIdToDelete) {
                toggleLoader(true);
                try {
                    await deleteDoc(doc(db, 'attendance', docIdToDelete));
                    showMessage("Entry deleted successfully.");
                } catch (error) {
                    showMessage("Error deleting entry: " + error.message);
                } finally {
                    docIdToDelete = null;
                    deleteConfirmModal.classList.add('hidden');
                    toggleLoader(false);
                }
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const docId = document.getElementById('edit-doc-id').value;
            const newDate = document.getElementById('edit-date').value;
            const newInTimeStr = document.getElementById('edit-in-time').value;
            const newOutTimeStr = document.getElementById('edit-out-time').value;

            const inTimeDate = new Date(`${newDate}T${newInTimeStr}`);
            const outTimeDate = newOutTimeStr ? new Date(`${newDate}T${newOutTimeStr}`) : null;
            
            const updatedData = {
                date: newDate,
                in_time: inTimeDate,
                out_time: outTimeDate,
                total_hours: calculateTotalHours(inTimeDate, outTimeDate)
            };

            try {
                const docRef = doc(db, 'attendance', docId);
                await updateDoc(docRef, updatedData);
                showMessage("Entry updated successfully.");
            } catch (error) {
                showMessage("Error updating entry: " + error.message);
            } finally {
                editModal.classList.add('hidden');
                toggleLoader(false);
            }
        });

        function exportDailyToCSV() {
            const headers = ["Date", "Employee Name", "In Time", "In Location", "Out Time", "Out Location", "Duty Hours"];
            
            const dataToExport = allAdminRecords.filter(rec => {
                 const date = filterDate.value;
                 const name = filterName.value.toLowerCase();
                 const nameMatch = name ? (rec.employee_name || '').toLowerCase().includes(name) : true;
                 const dateMatch = date ? rec.date === date : true;
                 return nameMatch && dateMatch;
            });

            const rows = dataToExport.map(rec => [
                rec.date,
                `"${rec.employee_name || 'N/A'}"`,
                rec.in_time ? `"${formatTime(rec.in_time.toDate())}"` : 'N/A',
                `"${rec.in_location || 'N/A'}"`,
                rec.out_time ? `"${formatTime(rec.out_time.toDate())}"` : 'N/A',
                `"${rec.out_location || 'N/A'}"`,
                `"${rec.total_hours || 'N/A'}"`
            ].join(','));

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `daily_attendance_export_${formatDate(new Date())}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        exportBtn.addEventListener('click', exportDailyToCSV);
        
        // Your other functions for monthly report, week-off setting, etc. are here
        // No changes were needed in their logic.
        // ... (The rest of your JS code is pasted here unchanged) ...
        // --- MONTHLY REPORT LOGIC ---
        monthlyReportBtn.addEventListener('click', () => {
            monthlyReportModal.classList.remove('hidden');
        });

        cancelMonthlyReportBtn.addEventListener('click', () => {
            monthlyReportModal.classList.add('hidden');
        });

        monthlyReportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const monthYear = document.getElementById('report-month').value;
            if(monthYear) {
                const [year, month] = monthYear.split('-');
                exportMonthlyReport(parseInt(year), parseInt(month));
                monthlyReportModal.classList.add('hidden');
            } else {
                showMessage("Please select a month.");
            }
        });

        async function exportMonthlyReport(year, month) {
            toggleLoader(true);
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && (today.getMonth() + 1) === month;
            const daysInMonth = new Date(year, month, 0).getDate();
            const daysToReport = isCurrentMonth ? today.getDate() : daysInMonth;

            const monthRecords = allAdminRecords.filter(rec => {
                const recDate = new Date(rec.date);
                return recDate.getFullYear() === year && recDate.getMonth() === month - 1;
            });
            
            const weekOffsCol = collection(db, 'weekoffs');
            const weekOffsQuery = query(weekOffsCol, where("year", "==", year), where("month", "==", month));
            const weekOffsSnapshot = await getDocs(weekOffsQuery);
            const monthWeekOffs = {};
            weekOffsSnapshot.forEach(doc => {
                const data = doc.data();
                monthWeekOffs[data.uid] = data.dates || [];
            });

            const holidayDocRef = doc(db, 'holidays', `${year}-${month}`);
            const holidayDoc = await getDoc(holidayDocRef);
            const holidaysInMonth = holidayDoc.exists() ? holidayDoc.data().dates : [];

            const coffsCol = collection(db, 'coffs');
            const coffsQuery = query(coffsCol, where("year", "==", year), where("month", "==", month), where("status", "==", "earned"));
            const coffsSnapshot = await getDocs(coffsQuery);
            const monthCoffs = {};
            coffsSnapshot.forEach(doc => {
                const data = doc.data();
                if (!monthCoffs[data.uid]) {
                    monthCoffs[data.uid] = 0;
                }
                monthCoffs[data.uid]++;
            });

            const reportData = {};

            allUsers.forEach(user => {
                reportData[user.uid] = {
                    name: user.name || 'Unknown',
                    empId: user.empId || '',
                    days: Array(daysInMonth + 1).fill('A'),
                };
            });
            
            for (let day = 1; day <= daysInMonth; day++) {
                for (const uid in reportData) {
                    if (holidaysInMonth.includes(day)) {
                        reportData[uid].days[day] = 'H';
                    } else {
                        const userWeekOffs = monthWeekOffs[uid] || [];
                        if (userWeekOffs.includes(day)) {
                            reportData[uid].days[day] = 'WO';
                        }
                    }
                }
            }

            monthRecords.forEach(rec => {
                if (reportData[rec.uid]) {
                    const dayOfMonth = new Date(rec.date).getDate();
                    reportData[rec.uid].days[dayOfMonth] = 'P';
                }
            });
            
            const headers = ['NAME', 'EMP ID'];
            for (let i = 1; i <= daysToReport; i++) {
                headers.push(`${i}-${month}-${year}`);
            }
            headers.push('TOTAL "P"', 'TOTAL "A"', 'TOTAL "WO"', 'TOTAL "H"', 'TOTAL CO', 'GRAND TOTAL');

            const rows = Object.keys(reportData).map(uid => {
                const emp = reportData[uid];
                const row = [ `"${emp.name}"`, `"${emp.empId}"` ];
                let pCount = 0, aCount = 0, woCount = 0, hCount = 0;

                for (let i = 1; i <= daysToReport; i++) {
                    row.push(emp.days[i]);
                    const status = emp.days[i];
                    if (status === 'P') pCount++;
                    else if (status === 'A') aCount++;
                    else if (status === 'WO') woCount++;
                    else if (status === 'H') hCount++;
                }
                
                const totalCO = monthCoffs[uid] || 0;
                
                row.push(pCount, aCount, woCount, hCount, totalCO, pCount + totalCO);
                return row.join(',');
            });

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `monthly_report_${year}_${month}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            toggleLoader(false);
        }

        // --- WEEK OFF SETTING LOGIC ---
        setWeekOffBtn.addEventListener('click', () => {
            weekOffModal.classList.remove('hidden');
            document.getElementById('week-off-month').valueAsDate = new Date();
            weekOffEmployeeList.innerHTML = '';
        });

        cancelWeekOffBtn.addEventListener('click', () => {
            weekOffModal.classList.add('hidden');
        });

        loadEmployeesBtn.addEventListener('click', async () => {
            const monthYear = document.getElementById('week-off-month').value;
            if (!monthYear) {
                showMessage("Please select a month first.");
                return;
            }
            toggleLoader(true);
            const [year, month] = monthYear.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const weekOffsCol = collection(db, 'weekoffs');
            const weekOffsQuery = query(weekOffsCol, where("year", "==", year), where("month", "==", month));
            const weekOffsSnapshot = await getDocs(weekOffsQuery);
            const existingWeekOffs = {};
            weekOffsSnapshot.forEach(doc => {
                const data = doc.data();
                existingWeekOffs[data.uid] = data.dates || [];
            });

            weekOffEmployeeList.innerHTML = '';
            allUsers.forEach(user => {
                const userWeekOffs = existingWeekOffs[user.uid] || [];
                let dateCheckboxes = '';
                for (let i = 1; i <= daysInMonth; i++) {
                    const isChecked = userWeekOffs.includes(i) ? 'checked' : '';
                    dateCheckboxes += `
                        <label class="inline-flex items-center mr-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600" value="${i}" data-uid="${user.uid}" ${isChecked}>
                            <span class="ml-1 text-sm">${i}</span>
                        </label>
                    `;
                }

                const userDiv = document.createElement('div');
                userDiv.className = 'p-2 border rounded';
                userDiv.innerHTML = `
                    <p class="font-semibold">${user.name}</p>
                    <div class="flex flex-wrap mt-2">${dateCheckboxes}</div>
                `;
                weekOffEmployeeList.appendChild(userDiv);
            });
            toggleLoader(false);
        });

        weekOffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const monthYear = document.getElementById('week-off-month').value;
            const [year, month] = monthYear.split('-').map(Number);

            const weekOffsByEmployee = {};
            allUsers.forEach(user => {
                weekOffsByEmployee[user.uid] = [];
            });

            const checkboxes = weekOffEmployeeList.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const uid = cb.dataset.uid;
                const day = parseInt(cb.value);
                if (weekOffsByEmployee[uid]) {
                    weekOffsByEmployee[uid].push(day);
                }
            });

            try {
                const batch = writeBatch(db);
                for (const uid in weekOffsByEmployee) {
                    const docId = `${uid}_${year}_${month}`;
                    const weekOffDocRef = doc(db, 'weekoffs', docId);
                    batch.set(weekOffDocRef, {
                        uid: uid,
                        year: year,
                        month: month,
                        dates: weekOffsByEmployee[uid]
                    });
                }
                await batch.commit();
                showMessage("Week offs saved successfully!");
                weekOffModal.classList.add('hidden');
            } catch (error) {
                showMessage("Error saving week offs: " + error.message);
            } finally {
                toggleLoader(false);
            }
        });

        // --- HOLIDAY SETTING LOGIC ---
        setHolidaysBtn.addEventListener('click', () => {
            holidaysModal.classList.remove('hidden');
            holidaysMonthInput.valueAsDate = new Date();
            holidaysMonthInput.dispatchEvent(new Event('change'));
        });

        cancelHolidaysBtn.addEventListener('click', () => {
            holidaysModal.classList.add('hidden');
        });

        holidaysMonthInput.addEventListener('change', async () => {
            const monthYear = holidaysMonthInput.value;
            if (!monthYear) {
                holidaysList.innerHTML = '';
                return;
            }
            toggleLoader(true);
            const [year, month] = monthYear.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            const holidayDocRef = doc(db, 'holidays', `${year}-${month}`);
            const holidayDoc = await getDoc(holidayDocRef);
            const existingHolidays = holidayDoc.exists() ? holidayDoc.data().dates : [];

            holidaysList.innerHTML = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const isChecked = existingHolidays.includes(i) ? 'checked' : '';
                const checkboxHTML = `
                    <label class="inline-flex items-center mr-2 mb-2">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600" value="${i}" ${isChecked}>
                        <span class="ml-1 text-sm">${i}</span>
                    </label>
                `;
                holidaysList.innerHTML += checkboxHTML;
            }
            toggleLoader(false);
        });

        holidaysForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const monthYear = holidaysMonthInput.value;
            const [year, month] = monthYear.split('-').map(Number);

            const selectedHolidays = [];
            const checkboxes = holidaysList.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                selectedHolidays.push(parseInt(cb.value));
            });

            try {
                const holidayDocRef = doc(db, 'holidays', `${year}-${month}`);
                await setDoc(holidayDocRef, {
                    year: year,
                    month: month,
                    dates: selectedHolidays
                });
                showMessage("Holidays saved successfully!");
                holidaysModal.classList.add('hidden');
            } catch (error) {
                showMessage("Error saving holidays: " + error.message);
            } finally {
                toggleLoader(false);
            }
        });

        // --- SHIFT CHANGE LOGIC ---
        shiftChangeRequestBtn.addEventListener('click', () => {
            shiftChangeModal.classList.remove('hidden');
            shiftChangeForm.reset();
            document.getElementById('shift-change-date').valueAsDate = new Date();
        });

        cancelShiftChangeBtn.addEventListener('click', () => {
            shiftChangeModal.classList.add('hidden');
        });

        shiftChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const colleagueEmpId = document.getElementById('colleague-empid').value;
            
            const colleague = allUsers.find(u => u.empId === colleagueEmpId);
            if (!colleague) {
                showMessage("Colleague with this Employee ID not found.");
                toggleLoader(false);
                return;
            }
            if (colleague.uid === currentUser.uid) {
                showMessage("You cannot request a shift change with yourself.");
                toggleLoader(false);
                return;
            }

            const request = {
                requester_uid: currentUser.uid,
                requester_name: currentUser.displayName,
                requester_shift: document.getElementById('my-shift').value,
                colleague_uid: colleague.uid,
                colleague_name: colleague.name,
                colleague_shift: document.getElementById('colleague-shift').value,
                change_date: document.getElementById('shift-change-date').value,
                remarks: document.getElementById('shift-change-remarks').value,
                status: 'pending',
                timestamp: Timestamp.now()
            };

            try {
                await addDoc(collection(db, 'shift_requests'), request);
                showMessage("Shift change request sent successfully.");
                shiftChangeModal.classList.add('hidden');
            } catch (error) {
                showMessage("Error sending request: " + error.message);
            } finally {
                toggleLoader(false);
            }
        });

        function listenForUserShiftRequests(uid) {
            const q = query(collection(db, 'shift_requests'), where("requester_uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                employeeRequestsBody.innerHTML = '';
                if (requests.length === 0) {
                    employeeRequestsBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">No requests found.</td></tr>`;
                }
                requests.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()).forEach(req => {
                    const row = document.createElement('tr');
                     row.className = 'hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="p-3">${req.change_date}</td>
                        <td class="p-3">${req.colleague_name}</td>
                        <td class="p-3">${req.requester_shift} ↔ ${req.colleague_shift}</td>
                        <td class="p-3">${getStatusBadge(req.status)}</td>
                    `;
                    employeeRequestsBody.appendChild(row);
                });
            });
        }

        function listenForAdminShiftRequests() {
            const q = query(collection(db, 'shift_requests'));
            shiftRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                adminRequestsBody.innerHTML = '';
                 if (requests.length === 0) {
                    adminRequestsBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-slate-500">No shift change requests.</td></tr>`;
                }
                requests.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()).forEach(req => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    const actions = req.status === 'pending' 
                        ? `<button class="approve-shift-btn bg-green-500 text-white px-2 py-1 rounded-md text-sm" data-id="${req.id}">Approve</button>
                           <button class="reject-shift-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm" data-id="${req.id}">Reject</button>`
                        : 'N/A';
                    row.innerHTML = `
                        <td class="p-3">${req.change_date}</td>
                        <td class="p-3">${req.requester_name}</td>
                        <td class="p-3">${req.colleague_name}</td>
                        <td class="p-3">${req.requester_shift} ↔ ${req.colleague_shift}</td>
                        <td class="p-3">${req.remarks}</td>
                        <td class="p-3">${getStatusBadge(req.status)}</td>
                        <td class="p-3 space-x-2">${actions}</td>
                    `;
                    adminRequestsBody.appendChild(row);
                });
            });
        }
        
        adminRequestsBody.addEventListener('click', async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            let newStatus = null;
            if (target.classList.contains('approve-shift-btn')) newStatus = 'approved';
            if (target.classList.contains('reject-shift-btn')) newStatus = 'rejected';

            if (newStatus) {
                toggleLoader(true);
                const requestRef = doc(db, 'shift_requests', id);
                try {
                    if (newStatus === 'approved') {
                        const requestDoc = await getDoc(requestRef);
                        const reqData = requestDoc.data();
                        
                        const attendanceCol = collection(db, 'attendance');
                        const q1 = query(attendanceCol, where("uid", "==", reqData.requester_uid), where("date", "==", reqData.change_date));
                        const q2 = query(attendanceCol, where("uid", "==", reqData.colleague_uid), where("date", "==", reqData.change_date));

                        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                        
                        const batch = writeBatch(db);
                        
                        if (!snap1.empty) {
                            const doc1 = snap1.docs[0];
                            batch.update(doc1.ref, { uid: reqData.colleague_uid, employee_name: reqData.colleague_name });
                        }
                         if (!snap2.empty) {
                            const doc2 = snap2.docs[0];
                            batch.update(doc2.ref, { uid: reqData.requester_uid, employee_name: reqData.requester_name });
                        }
                        
                        batch.update(requestRef, { status: newStatus });
                        await batch.commit();
                        showMessage("Shift change approved and records updated.");

                    } else { // Just reject
                        await updateDoc(requestRef, { status: newStatus });
                        showMessage("Shift change request rejected.");
                    }
                } catch (error) {
                    showMessage("Error updating request: " + error.message);
                } finally {
                    toggleLoader(false);
                }
            }
        });

        // Admin Tabs
        tabAttendance.addEventListener('click', () => {
            adminAttendanceView.classList.remove('hidden');
            adminShiftRequestsView.classList.add('hidden');
            tabAttendance.classList.add('border-indigo-500', 'text-indigo-600');
            tabShiftRequests.classList.remove('border-indigo-500', 'text-indigo-600');
            tabShiftRequests.classList.add('border-transparent');
        });
        tabShiftRequests.addEventListener('click', () => {
            adminAttendanceView.classList.add('hidden');
            adminShiftRequestsView.classList.remove('hidden');
            tabShiftRequests.classList.add('border-indigo-500', 'text-indigo-600');
            tabAttendance.classList.remove('border-indigo-500', 'text-indigo-600');
            tabAttendance.classList.add('border-transparent');
        });
    </script>
</body>
</html>