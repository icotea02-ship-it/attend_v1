<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Tracker</title>
    <!-- Tailwind CSS CDN script. Yeh saari styling handle karega. -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Sirf basic font aur loader yahan rakha gaya hai. Baaki sab Tailwind classes se hoga. */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .loader {
            border: 5px solid #e2e8f0;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .gradient-text {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
    </style>
</head>
<body class="text-slate-700 antialiased">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex flex-col items-center justify-center z-50 backdrop-blur-sm">
            <div class="loader"></div>
            <p class="text-white text-lg mt-4 font-semibold">Loading...</p>
        </div>

        <!-- Modals -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 text-center transform transition-all duration-300 scale-95 opacity-0">
                <p id="message-text" class="text-lg mb-6 text-slate-700"></p>
                <button id="close-message-btn" class="inline-flex items-center justify-center gap-2 font-bold py-2.5 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500">Close</button>
            </div>
        </div>
        <!-- Other modals like delete, edit, etc. will be dynamically created by JS if needed -->

        <!-- Authentication Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden mt-10 p-8 ring-1 ring-slate-200">
            <h2 class="text-3xl font-extrabold text-center mb-6 gradient-text">Employee Login</h2>
            <div id="auth-container">
                <form id="login-form" class="space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0 py-3" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0 py-3" required>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500">Login</button>
                </form>
                <p class="text-center mt-6 text-sm">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-indigo-600 hover:underline">Sign Up</a>
                </p>
            </div>
            <div id="signup-container" class="hidden">
                <form id="signup-form" class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="text" id="signup-empid" placeholder="Employee ID" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="text" id="signup-orgid" placeholder="Organization ID" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-emerald-500 text-white hover:bg-emerald-600 focus-visible:ring-emerald-500">Sign Up</button>
                </form>
                <p class="text-center mt-6 text-sm">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline">Login</a>
                </p>
            </div>
        </div>

        <!-- Main App Content (Hidden by default) -->
        <div id="app-content" class="hidden">
            <!-- Header -->
            <header class="bg-white rounded-xl shadow-lg p-5 ring-1 ring-slate-200 flex flex-col md:flex-row justify-between items-center mb-8">
                <h1 class="text-4xl font-extrabold gradient-text">Dashboard</h1>
                <div class="text-right mt-4 md:mt-0">
                    <p id="user-info" class="text-lg font-medium text-slate-700"></p>
                    <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:underline focus:outline-none">Logout</button>
                </div>
            </header>

            <!-- Actions Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Quick Actions</h2>
                <div class="flex flex-col sm:flex-row flex-wrap gap-4">
                    <button id="clock-in-btn" class="inline-flex items-center justify-center gap-2 font-bold py-2.5 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-emerald-500 text-white hover:bg-emerald-600 focus-visible:ring-emerald-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                        Clock In
                    </button>
                    <button id="clock-out-btn" class="inline-flex items-center justify-center gap-2 font-bold py-2.5 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-red-600 text-white hover:bg-red-700 focus-visible:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414L7 8.586V13a1 1 0 102 0v-3.586l1.707-1.707z" clip-rule="evenodd" /></svg>
                        Clock Out
                    </button>
                    <button id="shift-change-request-btn" class="inline-flex items-center justify-center gap-2 font-bold py-2.5 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" /></svg>
                        Request Shift Change
                    </button>
                </div>
                 <p id="location-status" class="mt-4 text-sm text-slate-600 font-medium">Checking your location...</p>
            </div>
            
            <!-- Employee's Data Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">My Attendance</h2>
                    <div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">In</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Out</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Hours</th>
                                </tr>
                            </thead>
                            <tbody id="employee-table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">My Shift Requests</h2>
                    <div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg">
                        <table class="w-full text-left">
                             <thead>
                                <tr class="bg-slate-100">
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">With</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Change</th>
                                    <th class="p-3 font-semibold text-slate-600 uppercase text-sm">Status</th>
                                </tr>
                            </thead>
                            <tbody id="employee-requests-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200">
                 <!-- Admin Panel content will be populated here by JS -->
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, updateDoc, setDoc, deleteDoc, getDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCEVg46yTI80gR-nlsf_T6_3HUtEi77Hj8",
            authDomain: "firstapp-cae0a.firebaseapp.com",
            projectId: "firstapp-cae0a",
            storageBucket: "firstapp-cae0a.firebasestorage.app",
            messagingSenderId: "48434901520",
            appId: "1:48434901520:web:dada602a58d99405505095",
            measurementId: "G-GC63DF4N8G"
        };
        
        const ADMIN_UID = 'LZC3oe3qOMQnGEN3FGppJIRyO462';
        const OFFICE_LOCATION = { latitude: 28.530243, longitude: 77.357587 };
        const GEOFENCE_RADIUS_METERS = 100; // Increased radius for better testing
        
        // --- DOM ELEMENT REFERENCES ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const signupContainer = document.getElementById('signup-container');
        const authContainer = document.getElementById('auth-container');
        const userInfo = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const locationStatus = document.getElementById('location-status');
        const employeeTableBody = document.getElementById('employee-table-body');
        const adminDashboard = document.getElementById('admin-dashboard');
        const employeeRequestsBody = document.getElementById('employee-requests-body');
        
        let currentUser = null;
        let userUnsubscribe = null;
        let adminUnsubscribe = null;
        let shiftRequestsUnsubscribe = null;
        let allUsers = [];
        
        // --- UTILITY FUNCTIONS for Modals, etc. ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        document.getElementById('close-message-btn').addEventListener('click', () => closeModal('message-modal'));
        
        function showMessage(message) {
            document.getElementById('message-text').textContent = message;
            openModal('message-modal');
        }

        function toggleLoader(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }
        // ... Other utility functions ...
        function getDistance(loc1, loc2) {
            const R = 6371e3; // metres
            const φ1 = loc1.latitude * Math.PI/180;
            const φ2 = loc2.latitude * Math.PI/180;
            const Δφ = (loc2.latitude-loc1.latitude) * Math.PI/180;
            const Δλ = (loc2.longitude-loc1.longitude) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function checkLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    locationStatus.innerHTML = `<span class="text-red-600">Geolocation is not supported.</span>`;
                    return reject("Geolocation Not Supported");
                }
                locationStatus.innerHTML = `Checking your location...`;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                        const distance = getDistance(userLocation, OFFICE_LOCATION);
                        if (distance <= GEOFENCE_RADIUS_METERS) {
                            locationStatus.innerHTML = `<span class="text-emerald-600">Status: You are within the office location.</span>`;
                            resolve("Within Location");
                        } else {
                            locationStatus.innerHTML = `<span class="text-red-600">Error: You are ${distance.toFixed(0)}m away. Clock-in/out is disabled.</span>`;
                            reject(`You are outside the allowed radius.`);
                        }
                    },
                    () => {
                        locationStatus.innerHTML = `<span class="text-red-600">Error: Location permission denied.</span>`;
                        reject("Location permission denied");
                    }
                );
            });
        }
        
        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function calculateTotalHours(inTime, outTime) {
            if (!inTime || !outTime) return "N/A";
            const diffMs = outTime.getTime() - inTime.getTime();
            if (diffMs < 0) return "Invalid";
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffMins = Math.round((diffMs % 3600000) / 60000);
            return `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'approved': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-100 text-emerald-800">Approved</span>`;
                case 'rejected': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>`;
                default: return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`;
            }
        }
        
        // --- FIREBASE INITIALIZATION & APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (userUnsubscribe) userUnsubscribe();
            if (adminUnsubscribe) adminUnsubscribe();
            if (shiftRequestsUnsubscribe) shiftRequestsUnsubscribe();

            if (user && !user.isAnonymous) {
                currentUser = user;
                const userDocSnap = await getDoc(doc(db, "users", user.uid));
                
                if (userDocSnap.exists()) {
                    currentUser.displayName = userDocSnap.data().name;
                    currentUser.empId = userDocSnap.data().empId;
                } else {
                    currentUser.displayName = user.email; // Fallback
                }

                userInfo.textContent = `Welcome, ${currentUser.displayName}`;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');

                await checkLocation().catch(err => console.log(err));
                listenForUserRecords(user.uid);
                listenForUserShiftRequests(user.uid);
                
                if (user.uid === ADMIN_UID) {
                    adminDashboard.classList.remove('hidden');
                    fetchAllUsers().then(() => {
                        // All admin logic is handled here
                    });
                } else {
                    adminDashboard.classList.add('hidden');
                }
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
            toggleLoader(false);
        });

        // --- AUTHENTICATION LISTENERS ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const email = loginForm.querySelector('#login-email').value;
            const password = loginForm.querySelector('#login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage("Login Failed: " + error.code.replace('auth/', '').replace(/-/g, ' '));
            } finally {
                toggleLoader(false);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const name = signupForm.querySelector('#signup-name').value;
            const email = signupForm.querySelector('#signup-email').value;
            const password = signupForm.querySelector('#signup-password').value;
            const empId = signupForm.querySelector('#signup-empid').value;
            const orgId = signupForm.querySelector('#signup-orgid').value;

            if (orgId !== `AN01${empId}`) {
                showMessage("Invalid Organization ID. Please check your details.");
                toggleLoader(false);
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    name: name,
                    email: email,
                    empId: empId
                });
                showMessage("Signup successful! Please login.");
                showLogin.click();
            } catch (error) {
                showMessage("Signup Failed: " + error.code.replace('auth/', '').replace(/-/g, ' '));
            } finally {
                toggleLoader(false);
            }
        });

        logoutBtn.addEventListener('click', () => { toggleLoader(true); signOut(auth); });
        showSignup.addEventListener('click', (e) => { e.preventDefault(); authContainer.classList.add('hidden'); signupContainer.classList.remove('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupContainer.classList.add('hidden'); authContainer.classList.remove('hidden'); });

        // --- DYNAMIC BUTTONS LOGIC ---
        function updateButtonState(button, enabled) {
            const activeClasses = ['bg-emerald-500', 'hover:bg-emerald-600', 'focus-visible:ring-emerald-500', 'bg-red-600', 'hover:bg-red-700', 'focus-visible:ring-red-500', 'hover:-translate-y-1', 'hover:shadow-lg', 'active:scale-95'];
            const disabledClasses = ['bg-slate-300', 'text-slate-500', 'cursor-not-allowed', 'shadow-none'];
            
            button.disabled = !enabled;
            if (enabled) {
                button.classList.remove(...disabledClasses);
            } else {
                button.classList.add(...disabledClasses);
                activeClasses.forEach(cls => {
                    if(button.classList.contains(cls)) {
                        // This logic could be improved, but for now it prevents adding active styles on top of disabled ones.
                    }
                })
            }
        }
        
        async function updateClockButtons(uid) {
            const todayStr = new Date().toISOString().split('T')[0];
            const q = query(collection(db, `attendance`), where("uid", "==", uid), where("date", "==", todayStr));
            const querySnapshot = await getDocs(q);
            
            updateButtonState(clockInBtn, false);
            updateButtonState(clockOutBtn, false);

            if (querySnapshot.empty) {
                updateButtonState(clockInBtn, true);
            } else {
                if (querySnapshot.docs[0].data().out_time === null) {
                    updateButtonState(clockOutBtn, true);
                }
            }
        }

        // --- DATA RELATED FUNCTIONS ---
        async function fetchAllUsers() {
             const userSnapshot = await getDocs(collection(db, 'users'));
             allUsers = userSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        function listenForUserRecords(uid) {
            const q = query(collection(db, `attendance`), where("uid", "==", uid));
            userUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                records.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
                
                employeeTableBody.innerHTML = records.map(rec => `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3">${rec.date}</td>
                        <td class="p-3">${rec.in_time ? formatTime(rec.in_time.toDate()) : 'N/A'}</td>
                        <td class="p-3">${rec.out_time ? formatTime(rec.out_time.toDate()) : 'N/A'}</td>
                        <td class="p-3">${rec.total_hours || 'N/A'}</td>
                    </tr>
                `).join('') || `<tr><td colspan="4" class="text-center p-4 text-slate-500">No records found.</td></tr>`;
                
                updateClockButtons(uid);
            });
        }
        
        function listenForUserShiftRequests(uid) {
            const q = query(collection(db, 'shift_requests'), where("requester_uid", "==", uid));
            shiftRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                 const requests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                 requests.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate());
                 
                 employeeRequestsBody.innerHTML = requests.map(req => `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3">${req.change_date}</td>
                        <td class="p-3 font-medium">${req.colleague_name}</td>
                        <td class="p-3">${req.requester_shift} ↔ ${req.colleague_shift}</td>
                        <td class="p-3">${getStatusBadge(req.status)}</td>
                    </tr>
                 `).join('') || `<tr><td colspan="4" class="text-center p-4 text-slate-500">No requests yet.</td></tr>`;
            });
        }
        
        // --- EVENT LISTENERS FOR CLOCKING IN/OUT ---
        clockInBtn.addEventListener('click', async () => { /* Logic is the same */ toggleLoader(true); try { await checkLocation(); const now = new Date(); await addDoc(collection(db, `attendance`), { uid: currentUser.uid, employee_name: currentUser.displayName, date: now.toISOString().split('T')[0], in_time: now, out_time: null, total_hours: null }); showMessage("Successfully clocked in!"); } catch (error) { showMessage(`Clock-in failed: ${error}`); } finally { toggleLoader(false); } });
        clockOutBtn.addEventListener('click', async () => { /* Logic is the same */ toggleLoader(true); try { await checkLocation(); const now = new Date(); const q = query(collection(db, `attendance`), where("uid", "==", currentUser.uid), where("date", "==", now.toISOString().split('T')[0]), where("out_time", "==", null)); const snap = await getDocs(q); if (!snap.empty) { const docRef = snap.docs[0].ref; await updateDoc(docRef, { out_time: now, total_hours: calculateTotalHours(snap.docs[0].data().in_time.toDate(), now) }); showMessage("Successfully clocked out!"); } else { showMessage("No open clock-in record found."); } } catch (error) { showMessage(`Clock-out failed: ${error}`); } finally { toggleLoader(false); } });

    </script>
</body>
</html>
