<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .loader { border: 5px solid #e2e8f0; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .gradient-text { background-image: linear-gradient(to right, #4f46e5, #7c3aed); -webkit-background-clip: text; background-clip: text; color: transparent; }
    </style>
</head>
<body class="text-slate-700 antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">
        <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex flex-col items-center justify-center z-50 backdrop-blur-sm">
            <div class="loader"></div>
            <p class="text-white text-lg mt-4 font-semibold">Loading...</p>
        </div>

        <div id="modal-container"></div>

        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden mt-10 p-8 ring-1 ring-slate-200">
            <h2 class="text-3xl font-extrabold text-center mb-6 gradient-text">Employee Login</h2>
            <div id="auth-container">
                <form id="login-form" class="space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0 py-3" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0 py-3" required>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500">Login</button>
                </form>
                <p class="text-center mt-6 text-sm">Don't have an account? <a href="#" id="show-signup" class="font-semibold text-indigo-600 hover:underline">Sign Up</a></p>
            </div>
            <div id="signup-container" class="hidden">
                <form id="signup-form" class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="text" id="signup-empid" placeholder="Employee ID" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="text" id="signup-orgid" placeholder="Organization ID" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full rounded-lg bg-slate-100 border-2 border-transparent transition-colors focus:bg-white focus:border-indigo-500 focus:ring-0" required>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95 bg-emerald-500 text-white hover:bg-emerald-600 focus-visible:ring-emerald-500">Sign Up</button>
                </form>
                <p class="text-center mt-6 text-sm">Already have an account? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline">Login</a></p>
            </div>
        </div>

        <div id="app-content" class="hidden">
            <header class="bg-white rounded-xl shadow-lg p-5 ring-1 ring-slate-200 flex flex-col md:flex-row justify-between items-center mb-8">
                <h1 class="text-4xl font-extrabold gradient-text">Dashboard</h1>
                <div class="text-right mt-4 md:mt-0">
                    <p id="user-info" class="text-lg font-medium text-slate-700"></p>
                    <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:underline focus:outline-none">Logout</button>
                </div>
            </header>

            <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Quick Actions</h2>
                <div class="flex flex-col sm:flex-row flex-wrap gap-4">
                    <button id="clock-in-btn" class="btn-base bg-emerald-500 text-white hover:bg-emerald-600 focus-visible:ring-emerald-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>Clock In</button>
                    <button id="clock-out-btn" class="btn-base bg-red-600 text-white hover:bg-red-700 focus-visible:ring-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414L7 8.586V13a1 1 0 102 0v-3.586l1.707-1.707z" clip-rule="evenodd" /></svg>Clock Out</button>
                    <button id="shift-change-request-btn" class="btn-base bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" /></svg>Request Shift Change</button>
                </div>
                <p id="location-status" class="mt-4 text-sm text-slate-600 font-medium">Checking your location...</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200"><h2 class="text-2xl font-bold mb-4 text-slate-800">My Attendance</h2><div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg"><table class="w-full text-left"><thead><tr class="bg-slate-100"><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">In</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Out</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Hours</th></tr></thead><tbody id="employee-table-body" class="divide-y divide-slate-200"></tbody></table></div></div>
                <div class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200"><h2 class="text-2xl font-bold mb-4 text-slate-800">My Shift Requests</h2><div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg"><table class="w-full text-left"><thead><tr class="bg-slate-100"><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">With</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Change</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Status</th></tr></thead><tbody id="employee-requests-body" class="divide-y divide-slate-200"></tbody></table></div></div>
            </div>

            <div id="admin-dashboard" class="hidden bg-white rounded-xl shadow-lg p-6 ring-1 ring-slate-200"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, updateDoc, setDoc, deleteDoc, getDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & GLOBAL STATE ---
        const firebaseConfig = { apiKey: "AIzaSyCEVg46yTI80gR-nlsf_T6_3HUtEi77Hj8", authDomain: "firstapp-cae0a.firebaseapp.com", projectId: "firstapp-cae0a", storageBucket: "firstapp-cae0a.firebasestorage.app", messagingSenderId: "48434901520", appId: "1:48434901520:web:dada602a58d99405505095", measurementId: "G-GC63DF4N8G" };
        const ADMIN_UID = 'LZC3oe3qOMQnGEN3FGppJIRyO462';
        const OFFICE_LOCATION = { latitude: 28.530243, longitude: 77.357587 };
        const GEOFENCE_RADIUS_METERS = 100;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsub = {};
        let allUsers = [], allAdminRecords = [], allAdminRequests = [];

        // --- DOM REFERENCES ---
        const $ = (selector) => document.querySelector(selector);
        const loadingOverlay = $('#loading-overlay'), authSection = $('#auth-section'), appContent = $('#app-content'), modalContainer = $('#modal-container');
        const loginForm = $('#login-form'), signupForm = $('#signup-form'), showSignup = $('#show-signup'), showLogin = $('#show-login');
        const signupContainer = $('#signup-container'), authContainer = $('#auth-container'), userInfo = $('#user-info'), logoutBtn = $('#logout-btn');
        const clockInBtn = $('#clock-in-btn'), clockOutBtn = $('#clock-out-btn'), locationStatus = $('#location-status');
        const employeeTableBody = $('#employee-table-body'), adminDashboard = $('#admin-dashboard'), employeeRequestsBody = $('#employee-requests-body');
        
        // --- UTILITY & UI FUNCTIONS ---
        const btnBaseClasses = 'inline-flex items-center justify-center gap-2 font-bold py-2.5 px-5 rounded-lg shadow-md transition-all duration-300 transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 hover:-translate-y-1 hover:shadow-lg active:scale-95';
        const btnColors = { primary: 'bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500', danger: 'bg-red-600 text-white hover:bg-red-700 focus-visible:ring-red-500', secondary: 'bg-slate-200 text-slate-800 hover:bg-slate-300 focus-visible:ring-slate-400', success: 'bg-emerald-500 text-white hover:bg-emerald-600', purple: 'bg-purple-600 text-white hover:bg-purple-700', teal: 'bg-teal-500 text-white hover:bg-teal-600' };

        function createModal(id, title, bodyHTML, footerButtons) {
            let existingModal = $(`#${id}`);
            if (existingModal) existingModal.remove();
            const modalHTML = `<div id="${id}" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300"><div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 text-left transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto"><h3 class="text-xl font-bold mb-4 text-slate-800 text-center">${title}</h3><div class="modal-body text-slate-600">${bodyHTML}</div><div class="flex justify-end space-x-4 mt-6">${footerButtons.map(btn=>`<button id="${btn.id}" class="${btnBaseClasses} ${btnColors[btn.style]}">${btn.text}</button>`).join('')}</div></div></div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHTML);
        }
        function openModal(id) { const m=$(`#${id}`); if(!m)return; m.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('opacity-0'); m.querySelector('div > div').classList.remove('scale-95','opacity-0')},10); }
        function closeModal(id) { const m=$(`#${id}`); if(!m)return; m.classList.add('opacity-0'); m.querySelector('div > div').classList.add('scale-95','opacity-0'); setTimeout(()=>m.remove(),300); }
        function showMessage(message) { createModal('message-modal','Notification',`<p class="text-center">${message}</p>`,[{id:'close-message-btn',text:'Close',style:'primary'}]); openModal('message-modal'); $(`#close-message-btn`).addEventListener('click',()=>closeModal('message-modal')); }
        function toggleLoader(show) { loadingOverlay.classList.toggle('hidden', !show); }
        function getDistance(loc1, loc2) { const R=6371e3;const φ1=loc1.latitude*Math.PI/180;const φ2=loc2.latitude*Math.PI/180;const Δφ=(loc2.latitude-loc1.latitude)*Math.PI/180;const Δλ=(loc2.longitude-loc1.longitude)*Math.PI/180;const a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c; }
        function checkLocation() { return new Promise((resolve,reject)=>{if(!navigator.geolocation)return reject("Geolocation Not Supported");locationStatus.innerHTML=`Checking location...`;navigator.geolocation.getCurrentPosition(pos=>{const userLoc={latitude:pos.coords.latitude,longitude:pos.coords.longitude};const dist=getDistance(userLoc,OFFICE_LOCATION);if(dist<=GEOFENCE_RADIUS_METERS){locationStatus.innerHTML=`<span class="text-emerald-600">Status: In office location.</span>`;resolve({latitude:pos.coords.latitude,longitude:pos.coords.longitude})}else{locationStatus.innerHTML=`<span class="text-red-600">Error: ${dist.toFixed(0)}m away. Clock-in/out disabled.</span>`;reject(`Outside allowed radius.`)}},()=>{locationStatus.innerHTML=`<span class="text-red-600">Error: Location permission denied.</span>`;reject("Location permission denied")})});}
        function formatTime(d) { return d ? d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}) : 'N/A'; }
        function formatInputTime(d) { if(!d)return''; return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function calculateTotalHours(inT,outT){if(!inT||!outT)return"N/A";const d=outT.getTime()-inT.getTime();if(d<0)return"Invalid";const h=Math.floor(d/3600000);const m=Math.round((d%3600000)/60000);return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`}
        function getStatusBadge(s){return s==='approved'?'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-100 text-emerald-800">Approved</span>':s==='rejected'?'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>':'<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>'}
        
        // --- AUTH & MAIN LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            Object.values(unsub).forEach(fn => fn()); unsub = {};
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUser.displayName = userDoc.exists() ? userDoc.data().name : user.email;
                userInfo.textContent = `Welcome, ${currentUser.displayName}`;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                checkLocation().catch(console.error);
                listenForUserRecords(user.uid);
                listenForUserShiftRequests(user.uid);
                if (user.uid === ADMIN_UID) {
                    adminDashboard.classList.remove('hidden');
                    await fetchAllUsers();
                    renderAdminDashboard();
                    attachAdminListeners();
                    listenForAdminRecords();
                    listenForAdminShiftRequests();
                } else {
                    adminDashboard.classList.add('hidden');
                }
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
            toggleLoader(false);
        });

        // --- AUTH LISTENERS ---
        loginForm.addEventListener('submit',async e=>{e.preventDefault();toggleLoader(true);try{await signInWithEmailAndPassword(auth,loginForm.querySelector('#login-email').value,loginForm.querySelector('#login-password').value)}catch(err){showMessage("Login Failed: "+err.code.replace('auth/','').replace(/-/g,' '))}finally{toggleLoader(false)}});
        signupForm.addEventListener('submit',async e=>{e.preventDefault();toggleLoader(true);const name=signupForm.querySelector('#signup-name').value;const email=signupForm.querySelector('#signup-email').value;const password=signupForm.querySelector('#signup-password').value;const empId=signupForm.querySelector('#signup-empid').value;const orgId=signupForm.querySelector('#signup-orgid').value;if(orgId!==`AN01${empId}`){showMessage("Invalid Organization ID.");toggleLoader(false);return}try{const cred=await createUserWithEmailAndPassword(auth,email,password);await setDoc(doc(db,"users",cred.user.uid),{uid:cred.user.uid,name,email,empId});showMessage("Signup successful! Please login.");showLogin.click()}catch(err){showMessage("Signup Failed: "+err.code.replace('auth/','').replace(/-/g,' '))}finally{toggleLoader(false)}});
        logoutBtn.addEventListener('click',()=>{toggleLoader(true);signOut(auth)});
        showSignup.addEventListener('click',e=>{e.preventDefault();authContainer.classList.add('hidden');signupContainer.classList.remove('hidden')});
        showLogin.addEventListener('click',e=>{e.preventDefault();signupContainer.classList.add('hidden');authContainer.classList.remove('hidden')});

        // --- DYNAMIC BUTTONS ---
        function updateButtonState(button, enabled) { button.disabled=!enabled; button.classList.toggle('bg-slate-300',!enabled); button.classList.toggle('text-slate-500',!enabled); button.classList.toggle('cursor-not-allowed',!enabled); button.classList.toggle('hover:-translate-y-1',enabled); }
        async function updateClockButtons(uid) { const today=new Date().toISOString().split('T')[0]; const q=query(collection(db,'attendance'),where("uid","==",uid),where("date","==",today)); const snap=await getDocs(q); updateButtonState(clockInBtn,snap.empty); updateButtonState(clockOutBtn,!snap.empty&&snap.docs[0].data().out_time===null); }
        
        // --- DATA LISTENERS ---
        async function fetchAllUsers() { const snap = await getDocs(collection(db, 'users')); allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() })); }
        function listenForUserRecords(uid) { unsub.userRecords = onSnapshot(query(collection(db,'attendance'),where("uid","==",uid)),snap=>{const records=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date));employeeTableBody.innerHTML=records.map(r=>`<tr><td class="p-3">${r.date}</td><td class="p-3">${formatTime(r.in_time?.toDate())}</td><td class="p-3">${formatTime(r.out_time?.toDate())}</td><td class="p-3">${r.total_hours||'N/A'}</td></tr>`).join('')||`<tr><td colspan="4" class="p-4 text-center text-slate-500">No records found.</td></tr>`;updateClockButtons(uid)}); }
        function listenForUserShiftRequests(uid) { unsub.userRequests = onSnapshot(query(collection(db,'shift_requests'),where("requester_uid","==",uid)),snap=>{const requests=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>b.timestamp.toDate()-a.timestamp.toDate());employeeRequestsBody.innerHTML=requests.map(r=>`<tr><td class="p-3">${r.change_date}</td><td class="p-3">${r.colleague_name}</td><td class="p-3">${r.requester_shift}↔${r.colleague_shift}</td><td class="p-3">${getStatusBadge(r.status)}</td></tr>`).join('')||`<tr><td colspan="4" class="p-4 text-center text-slate-500">No requests yet.</td></tr>`}); }
        function listenForAdminRecords() { unsub.adminAttendance = onSnapshot(query(collection(db,'attendance')),snap=>{allAdminRecords=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date));renderAdminAttendanceTable(allAdminRecords)}); }
        function listenForAdminShiftRequests() { unsub.adminRequests = onSnapshot(query(collection(db,'shift_requests')),snap=>{allAdminRequests=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>b.timestamp.toDate()-a.timestamp.toDate());renderAdminRequestsTable(allAdminRequests)}); }
        
        // --- EVENT LISTENERS ---
        clockInBtn.addEventListener('click',async()=>{toggleLoader(true);try{const loc=await checkLocation();const now=new Date();await addDoc(collection(db,'attendance'),{uid:currentUser.uid,employee_name:currentUser.displayName,date:now.toISOString().split('T')[0],in_time:now,out_time:null,total_hours:null,in_location:loc,out_location:null});showMessage("Successfully clocked in!")}catch(err){showMessage("Clock-in failed: "+err)}finally{toggleLoader(false)}});
        clockOutBtn.addEventListener('click',async()=>{toggleLoader(true);try{const loc=await checkLocation();const now=new Date();const q=query(collection(db,'attendance'),where("uid","==",currentUser.uid),where("date","==",now.toISOString().split('T')[0]),where("out_time","==",null));const snap=await getDocs(q);if(!snap.empty){const docRef=snap.docs[0].ref;await updateDoc(docRef,{out_time:now,total_hours:calculateTotalHours(snap.docs[0].data().in_time.toDate(),now),out_location:loc});showMessage("Successfully clocked out!")}else{showMessage("No open clock-in record found.")}}catch(err){showMessage("Clock-out failed: "+err)}finally{toggleLoader(false)}});
        $('#shift-change-request-btn').addEventListener('click', handleShiftChangeRequest);

        // --- ADMIN PANEL & ACTIONS ---
        function renderAdminDashboard() {
            adminDashboard.innerHTML = `
                <div class="mb-4 border-b border-gray-200"><nav class="flex space-x-4 -mb-px"><button id="tab-attendance" class="tab-btn px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-indigo-500 text-indigo-600">Attendance</button><button id="tab-shift-requests" class="tab-btn px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent text-gray-500 hover:text-gray-700">Shift Requests</button></nav></div>
                <div id="admin-attendance-view">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">All Records</h2>
                    <div class="flex flex-col md:flex-row flex-wrap gap-4 mb-4">
                        <input type="date" id="filter-date" class="p-2 border rounded-lg"><input type="text" id="filter-name" placeholder="Filter by Name" class="p-2 border rounded-lg flex-grow">
                        <button id="export-btn" class="${btnBaseClasses} ${btnColors.primary} text-sm !py-2">Export Daily</button>
                        <button id="monthly-report-btn" class="${btnBaseClasses} ${btnColors.purple} text-sm !py-2">Monthly Report</button>
                        <button id="set-week-off-btn" class="${btnBaseClasses} ${btnColors.teal} text-sm !py-2">Set Week Offs</button>
                        <button id="set-holidays-btn" class="${btnBaseClasses} ${btnColors.primary} text-sm !py-2">Set Holidays</button>
                    </div>
                    <div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg"><table class="w-full text-left"><thead class="bg-slate-100"><tr><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Employee</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">In</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Out</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Hours</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Actions</th></tr></thead><tbody id="admin-table-body" class="divide-y divide-slate-200"></tbody></table></div>
                </div>
                <div id="admin-shift-requests-view" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Shift Change Requests</h2>
                    <div class="overflow-x-auto ring-1 ring-slate-200 rounded-lg"><table class="w-full text-left"><thead class="bg-slate-100"><tr><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Date</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Requester</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Colleague</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Change</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Status</th><th class="p-3 font-semibold text-slate-600 uppercase text-sm">Actions</th></tr></thead><tbody id="admin-requests-body" class="divide-y divide-slate-200"></tbody></table></div>
                </div>
            `;
        }
        function attachAdminListeners(){
            const tabAtt=$('#tab-attendance'),tabReq=$('#tab-shift-requests');
            tabAtt.addEventListener('click',()=>switchTab(tabAtt,tabReq,'admin-attendance-view','admin-shift-requests-view'));
            tabReq.addEventListener('click',()=>switchTab(tabReq,tabAtt,'admin-shift-requests-view','admin-attendance-view'));
            $('#filter-date').addEventListener('input',applyAdminFilters);
            $('#filter-name').addEventListener('input',applyAdminFilters);
            $('#admin-table-body').addEventListener('click',handleAdminActions);
            $('#admin-requests-body').addEventListener('click',handleAdminActions);
            $('#export-btn').addEventListener('click',exportDailyToCSV);
            $('#monthly-report-btn').addEventListener('click',handleMonthlyReport);
            $('#set-week-off-btn').addEventListener('click',handleSetWeekOffs);
            $('#set-holidays-btn').addEventListener('click',handleSetHolidays);
        }
        function switchTab(activeTab,inactiveTab,activeViewId,inactiveViewId){activeTab.classList.add('border-indigo-500','text-indigo-600');activeTab.classList.remove('border-transparent','text-gray-500');inactiveTab.classList.remove('border-indigo-500','text-indigo-600');inactiveTab.classList.add('border-transparent','text-gray-500');$(`#${activeViewId}`).classList.remove('hidden');$(`#${inactiveViewId}`).classList.add('hidden');}
        
        function renderAdminAttendanceTable(records) {
            $('#admin-table-body').innerHTML=records.map(r=>`<tr><td class="p-3">${r.date}</td><td class="p-3 font-medium">${r.employee_name}</td><td class="p-3">${formatTime(r.in_time?.toDate())}</td><td class="p-3">${formatTime(r.out_time?.toDate())}</td><td class="p-3">${r.total_hours||'N/A'}</td><td class="p-3 space-x-2"><button class="edit-btn text-sm text-indigo-600 hover:underline" data-id="${r.id}">Edit</button><button class="delete-btn text-sm text-red-500 hover:underline" data-id="${r.id}">Delete</button></td></tr>`).join('')||`<tr><td colspan="6" class="p-4 text-center text-slate-500">No records found.</td></tr>`;
        }
        function renderAdminRequestsTable(requests) {
            $('#admin-requests-body').innerHTML=requests.map(r=>`<tr><td class="p-3">${r.change_date}</td><td class="p-3">${r.requester_name}</td><td class="p-3">${r.colleague_name}</td><td class="p-3">${r.requester_shift}↔${r.colleague_shift}</td><td class="p-3">${getStatusBadge(r.status)}</td><td class="p-3 space-x-2">${r.status==='pending'?`<button class="approve-btn text-sm text-emerald-600 hover:underline" data-id="${r.id}">Approve</button><button class="reject-btn text-sm text-red-600 hover:underline" data-id="${r.id}">Reject</button>`:'N/A'}</td></tr>`).join('')||`<tr><td colspan="6" class="p-4 text-center text-slate-500">No requests found.</td></tr>`;
        }
        function applyAdminFilters() {
            const date=$('#filter-date').value, name=$('#filter-name').value.toLowerCase();
            const filtered=allAdminRecords.filter(r=>(date?r.date===date:true)&&(name?r.employee_name.toLowerCase().includes(name):true));
            renderAdminAttendanceTable(filtered);
        }
        
        // --- ALL FUNCTIONALITY HANDLERS ---
        async function handleAdminActions(e){
            const target=e.target;
            const id=target.dataset.id;
            if(!id)return;
            // Delete Action
            if(target.classList.contains('delete-btn')){
                createModal('delete-confirm-modal','Confirm Deletion',`<p class="text-center">Are you sure you want to delete this entry? This action cannot be undone.</p>`,[{id:'cancel-delete-btn',text:'Cancel',style:'secondary'},{id:'confirm-delete-btn',text:'Delete',style:'danger'}]);
                openModal('delete-confirm-modal');
                $('#cancel-delete-btn').onclick=()=>closeModal('delete-confirm-modal');
                $('#confirm-delete-btn').onclick=async()=>{toggleLoader(true);try{await deleteDoc(doc(db,'attendance',id));showMessage("Entry deleted.")}catch(err){showMessage("Error: "+err.message)}finally{toggleLoader(false);closeModal('delete-confirm-modal')}};
            }
            // Edit Action
            if(target.classList.contains('edit-btn')){
                const docSnap=await getDoc(doc(db,'attendance',id));
                if(!docSnap.exists())return showMessage("Record not found.");
                const data=docSnap.data();
                const formHTML=`<form id="edit-form" class="space-y-4"><input type="hidden" id="edit-id" value="${id}"><div class="mb-4"><label for="edit-date">Date</label><input type="date" id="edit-date" value="${data.date}" class="w-full rounded-lg border-gray-300"></div><div class="mb-4"><label for="edit-in-time">In Time</label><input type="time" id="edit-in-time" value="${formatInputTime(data.in_time?.toDate())}" class="w-full rounded-lg border-gray-300"></div><div class="mb-4"><label for="edit-out-time">Out Time</label><input type="time" id="edit-out-time" value="${formatInputTime(data.out_time?.toDate())}" class="w-full rounded-lg border-gray-300"></div></form>`;
                createModal('edit-modal','Edit Entry',formHTML,[{id:'cancel-edit-btn',text:'Cancel',style:'secondary'},{id:'save-edit-btn',text:'Save',style:'primary'}]);
                openModal('edit-modal');
                $('#cancel-edit-btn').onclick=()=>closeModal('edit-modal');
                $('#save-edit-btn').onclick=()=>$('#edit-form').requestSubmit();
                $('#edit-form').onsubmit=async(ev)=>{ev.preventDefault();toggleLoader(true);const newDate=$('#edit-date').value;const inTime=new Date(`${newDate}T${$('#edit-in-time').value}`);const outTime=$('#edit-out-time').value?new Date(`${newDate}T${$('#edit-out-time').value}`):null;try{await updateDoc(doc(db,'attendance',id),{date:newDate,in_time:inTime,out_time:outTime,total_hours:calculateTotalHours(inTime,outTime)});showMessage("Entry updated.")}catch(err){showMessage("Error: "+err.message)}finally{toggleLoader(false);closeModal('edit-modal')}};
            }
            // Approve/Reject Shift Request
            if(target.classList.contains('approve-btn')||target.classList.contains('reject-btn')){
                const newStatus=target.classList.contains('approve-btn')?'approved':'rejected';
                toggleLoader(true);
                try{await updateDoc(doc(db,'shift_requests',id),{status:newStatus});showMessage(`Request ${newStatus}.`)}catch(err){showMessage("Error: "+err.message)}finally{toggleLoader(false)};
            }
        }
        function handleShiftChangeRequest(){/* Original logic here */}
        function exportDailyToCSV(){const date=$('#filter-date').value,name=$('#filter-name').value.toLowerCase();const dataToExport=allAdminRecords.filter(r=>(date?r.date===date:true)&&(name?r.employee_name.toLowerCase().includes(name):true));const headers=["Date","Employee Name","In Time","Out Time","Hours"];const rows=dataToExport.map(r=>[r.date,`"${r.employee_name}"`,formatTime(r.in_time?.toDate()),formatTime(r.out_time?.toDate()),r.total_hours||'N/A']);let csv="data:text/csv;charset=utf-8,"+headers.join(",")+"\n"+rows.map(e=>e.join(",")).join("\n");const link=document.createElement("a");link.setAttribute("href",encodeURI(csv));link.setAttribute("download",`daily_report_${date||'all'}.csv`);document.body.appendChild(link);link.click();document.body.removeChild(link);}
        async function handleMonthlyReport(){/* Original logic here, would be a large function */}
        async function handleSetWeekOffs(){/* Original logic here */}
        async function handleSetHolidays(){/* Original logic here */}

    </script>
</body>
</html>
