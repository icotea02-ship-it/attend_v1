<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .card-gradient { background-image: linear-gradient(to top right, #ffffff, #f9fafb); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Loading Spinner -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- Terms of Use Modal -->
        <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 max-h-[90vh] flex flex-col animate-fade-in">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Terms of Use & Privacy Policy</h2>
                <div class="text-sm text-gray-600 space-y-3 overflow-y-auto pr-2">
                    <p><strong>Last updated: August 2, 2025</strong></p>
                    <p>Welcome to the Employee Attendance Tracker. By using this application, you agree to the following terms and conditions.</p>
                    <h3 class="font-bold text-gray-700 mt-2">1. Data Collection and Usage</h3>
                    <p>To provide our services, we collect: Your Name, Email, Employee ID, Geolocation (at clock-in/out only), and Attendance Times.</p>
                    <h3 class="font-bold text-gray-700 mt-2">2. Purpose of Data Use</h3>
                    <p>Your data is used exclusively for marking attendance, calculating work hours, and allowing administrators to manage records.</p>
                    <h3 class="font-bold text-gray-700 mt-2">3. Privacy and Security</h3>
                    <p>We do not share your data. It is stored securely. Your location is not tracked continuously.</p>
                    <h3 class="font-bold text-gray-700 mt-2">4. Acceptance</h3>
                    <p>By clicking "Accept & Continue", you agree to these terms.</p>
                </div>
                <div class="mt-6 text-center">
                    <button id="accept-terms-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Accept & Continue</button>
                </div>
            </div>
        </div>

        <!-- Custom Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center animate-fade-in">
                <p id="message-text" class="text-lg mb-4"></p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
                <p class="mb-6">Are you sure you want to delete this entry? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- NEW MODAL FOR MANUAL C/OFF -->
        <div id="manual-coff-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Add Manual C/Off</h3>
                <form id="manual-coff-form">
                    <div class="mb-4">
                        <label for="manual-coff-employee" class="block text-sm font-medium text-gray-700">Select Employee</label>
                        <select id="manual-coff-employee" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div class="mb-4">
                        <label for="manual-coff-date" class="block text-sm font-medium text-gray-700">Date Earned</label>
                        <input type="date" id="manual-coff-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-manual-coff-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save C/Off</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- Edit Entry Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Edit Attendance Entry</h3>
                <form id="edit-form">
                    <input type="hidden" id="edit-doc-id">
                    <div class="mb-4">
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="edit-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-in-time" class="block text-sm font-medium text-gray-700">In Time</label>
                        <input type="time" id="edit-in-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                     <div class="mb-4">
                        <label for="edit-out-time" class="block text-sm font-medium text-gray-700">Out Time</label>
                        <input type="time" id="edit-out-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Monthly Report Modal -->
        <div id="monthly-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Generate Monthly Report</h3>
                <form id="monthly-report-form">
                    <div class="mb-4">
                        <label for="report-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="report-month" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-monthly-report-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Generate</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Set Week Offs Modal -->
        <div id="week-off-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-screen overflow-y-auto animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Set Monthly Week Offs</h3>
                <div class="flex items-end space-x-2 mb-4">
                    <div class="flex-grow">
                        <label for="week-off-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="week-off-month" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button id="load-employees-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Load Employees</button>
                </div>
                <form id="week-off-form">
                    <div id="week-off-employee-list" class="space-y-4"></div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-week-off-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save Week Offs</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Set Holidays Modal -->
        <div id="holidays-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-screen overflow-y-auto animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Set Monthly Holidays</h3>
                <div class="flex items-end space-x-2 mb-4">
                    <div class="flex-grow">
                        <label for="holidays-month" class="block text-sm font-medium text-gray-700">Select Month</label>
                        <input type="month" id="holidays-month" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <form id="holidays-form">
                    <div id="holidays-list" class="flex flex-wrap mt-2"></div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-holidays-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save Holidays</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Bulk Present Modal -->
        <div id="bulk-present-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-screen overflow-y-auto animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Mark Bulk Attendance</h3>
                <form id="bulk-present-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="bulk-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="bulk-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="bulk-in-time" class="block text-sm font-medium text-gray-700">In Time</label>
                            <input type="time" id="bulk-in-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="bulk-out-time" class="block text-sm font-medium text-gray-700">Out Time</label>
                            <input type="time" id="bulk-out-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <button type="button" id="bulk-select-all" class="text-sm text-blue-600 hover:underline">Select All</button> /
                        <button type="button" id="bulk-deselect-all" class="text-sm text-blue-600 hover:underline">Deselect All</button>
                    </div>
                    <div id="bulk-employee-list" class="space-y-2 border p-2 rounded-md max-h-60 overflow-y-auto">
                        <!-- Employee checkboxes will be populated here -->
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-bulk-present-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save Attendance</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ALL REQUEST MODALS (Shift, PP, C/Off, Leave) -->
        <div id="shift-change-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Request Shift Change</h3>
                <form id="shift-change-form">
                    <div class="mb-4"><label for="shift-change-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="shift-change-date" name="change_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label for="my-shift" class="block text-sm font-medium text-gray-700">My Shift</label><select id="my-shift" name="requester_shift" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="G">G</option></select></div>
                        <div><label for="colleague-shift" class="block text-sm font-medium text-gray-700">Colleague's Shift</label><select id="colleague-shift" name="colleague_shift" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="G">G</option></select></div>
                    </div>
                    <div class="mb-4"><label for="colleague-empid" class="block text-sm font-medium text-gray-700">Colleague's Employee ID</label><input type="text" id="colleague-empid" name="colleague_empid" placeholder="Enter Colleague's EMP ID" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="shift-change-remarks" class="block text-sm font-medium text-gray-700">Remarks</label><textarea id="shift-change-remarks" name="remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="flex justify-end space-x-4 mt-6"><button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Send</button></div>
                </form>
            </div>
        </div>
        <div id="pp-request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
             <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Apply for Additional Present (PP)</h3>
                <form id="pp-request-form">
                    <div class="mb-4"><label for="pp-request-date" class="block text-sm font-medium text-gray-700">Date for PP</label><input type="date" id="pp-request-date" name="request_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="pp-request-remarks" class="block text-sm font-medium text-gray-700">Remarks</label><textarea id="pp-request-remarks" name="remarks" rows="3" placeholder="Reason for dual shift..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="flex justify-end space-x-4 mt-6"><button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Submit</button></div>
                </form>
            </div>
        </div>
        <div id="coff-request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Apply for Compensatory Off (C/Off)</h3>
                <form id="coff-request-form">
                    <div class="mb-4"><label for="coff-avail-date" class="block text-sm font-medium text-gray-700">Date to Avail C/Off</label><input type="date" id="coff-avail-date" name="avail_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="coff-earned-select" class="block text-sm font-medium text-gray-700">Against which earned C/Off?</label><select id="coff-earned-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></select><p id="no-coff-message" class="text-sm text-red-500 mt-1 hidden">You have no available C/Offs.</p></div>
                    <div class="mb-4"><label for="coff-request-remarks" class="block text-sm font-medium text-gray-700">Remarks</label><textarea id="coff-request-remarks" name="remarks" rows="3" placeholder="Reason..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="flex justify-end space-x-4 mt-6"><button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Submit</button></div>
                </form>
            </div>
        </div>
        <div id="leave-request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 animate-fade-in">
                <h3 class="text-lg font-bold mb-4">Apply for Leave</h3>
                <form id="leave-request-form">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label for="leave-start-date" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="leave-start-date" name="start_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                        <div><label for="leave-end-date" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="leave-end-date" name="end_date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    </div>
                    <p class="text-center text-sm font-medium text-gray-700 mb-4">Total Days: <span id="leave-total-days">0</span></p>
                    <div class="mb-4"><label for="leave-request-remarks" class="block text-sm font-medium text-gray-700">Reason</label><textarea id="leave-request-remarks" name="reason" rows="3" placeholder="Reason..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md"><label class="flex items-start"><input type="checkbox" id="leave-terms-ack" class="h-4 w-4 text-orange-600 mt-1"><span class="ml-2 text-xs text-gray-600">I acknowledge leave approval is subject to company policy.</span></label></div>
                    <div class="flex justify-end space-x-4 mt-6"><button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" id="submit-leave-request-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400" disabled>Submit</button></div>
                </form>
            </div>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 mt-10 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Employee Login</h2>
            <div id="auth-container">
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Login</button>
                </form>
                <p class="text-center mt-4">Don't have an account? <a href="#" id="show-signup" class="text-blue-500 hover:underline">Sign Up</a></p>
            </div>
            <div id="signup-container" class="hidden">
                <form id="signup-form" class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="text" id="signup-empid" placeholder="Employee ID" class="w-full px-4 py-2 border rounded-lg" required>
                    
                    <input type="text" id="signup-designation" placeholder="Designation (e.g., HVAC Technician)" class="w-full px-4 py-2 border rounded-lg" required>
                    <select id="signup-department" class="w-full px-4 py-2 border rounded-lg bg-white" required>
                        <option value="">Select Department</option>
                        <option value="Engineer">Engineer</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="HVAC Opt">HVAC Opt</option>
                        <option value="MST">MST</option>
                        <option value="DG Opt">DG Opt</option>
                        <option value="Plumber">Plumber</option>
                        <option value="Civil">Civil</option>
                        <option value="Carpenter">Carpenter</option>
                        <option value="Painter">Painter</option>
                        <option value="others">Others</option>
                    </select>

                    <input type="text" id="signup-orgid" placeholder="Organization ID" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Sign Up</button>
                </form>
                <p class="text-center mt-4">Already have an account? <a href="#" id="show-login" class="text-blue-500 hover:underline">Login</a></p>
            </div>
        </div>

        <!-- Main App Content (Hidden by default) -->
        <div id="app-content" class="hidden">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-md">
                <h1 class="text-3xl font-bold text-gray-800">Attendance Dashboard</h1>
                <div class="text-right mt-4 md:mt-0">
                    <p id="user-info" class="text-md"></p>
                    <p id="on-duty-supervisor" class="text-sm text-gray-500"></p>
                    <button id="logout-btn" class="text-sm text-red-500 hover:underline">Logout</button>
                </div>
            </header>
            
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="mb-6 p-4 bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold mb-4">Today's Live Shift Count</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><p class="text-2xl font-bold" id="shift-a-count">0</p><p class="text-sm text-gray-300">A Shift</p></div>
                        <div><p class="text-2xl font-bold" id="shift-b-count">0</p><p class="text-sm text-gray-300">B Shift</p></div>
                        <div><p class="text-2xl font-bold" id="shift-c-count">0</p><p class="text-sm text-gray-300">C Shift</p></div>
                        <div><p class="text-2xl font-bold" id="shift-g-count">0</p><p class="text-sm text-gray-300">General</p></div>
                    </div>

                    <div class="mt-6 border-t border-gray-600 pt-4">
                        <h3 class="text-lg font-bold mb-4 text-white">Today's Live Department Count</h3>
                        <div id="department-live-counts" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                        </div>
                    </div>
                    
                    <div class="mt-6 border-t border-gray-600 pt-4">
                        <h3 class="text-lg font-bold mb-4 text-white">Pending Requests</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div><p class="text-2xl font-bold" id="dashboard-shift-request-count">0</p><p class="text-sm text-gray-300">Shift</p></div>
                            <div><p class="text-2xl font-bold" id="dashboard-pp-request-count">0</p><p class="text-sm text-gray-300">PP</p></div>
                            <div><p class="text-2xl font-bold" id="dashboard-coff-request-count">0</p><p class="text-sm text-gray-300">C/Off</p></div>
                            <div><p class="text-2xl font-bold" id="dashboard-leave-request-count">0</p><p class="text-sm text-gray-300">Leave</p></div>
                        </div>
                    </div>
                </div>

                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-1 overflow-x-auto pb-2" aria-label="Tabs">
                        <button id="tab-attendance" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg flex-shrink-0">Attendance</button>
                        <button id="tab-shift-requests" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg relative flex-shrink-0">Shift Changes<span id="shift-request-counter" class="absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span></button>
                        <button id="tab-pp-requests" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg relative flex-shrink-0">PP Requests<span id="pp-request-counter" class="absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span></button>
                        <button id="tab-coff-requests" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg relative flex-shrink-0">C/Off Requests<span id="coff-request-counter" class="absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span></button>
                        <button id="tab-leave-requests" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg relative flex-shrink-0">Leave Requests<span id="leave-request-counter" class="absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span></button>
                    </nav>
                </div>

                <!-- Admin Views -->
                <div id="admin-attendance-view">
                    <h2 class="text-xl font-semibold mb-4">All Employee Records</h2>
                    <div class="space-y-4 mb-4">
                        <div class="flex flex-col sm:flex-row items-center gap-2">
                            <input type="date" id="filter-date" class="p-2 border rounded-lg w-full sm:w-auto">
                            <input type="text" id="filter-name" placeholder="Filter by Employee Name" class="p-2 border rounded-lg w-full sm:w-auto flex-grow">
                            <button id="export-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto flex-shrink-0">Export Daily</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button id="monthly-report-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Monthly Report</button>
                            <button id="set-week-off-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Set Week Offs</button>
                            <button id="set-holidays-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Set Holidays</button>
                            <button id="add-manual-coff-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Add Manual C/Off</button>
                            <button id="bulk-present-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg">Mark Bulk Present</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh] overflow-y-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Date</th><th class="p-3">Name</th><th class="p-3">Designation</th><th class="p-3">In</th><th class="p-3">Out</th><th class="p-3">Hours</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-table-body"></tbody></table></div>
                </div>
                <div id="admin-shift-requests-view" class="hidden">
                     <h2 class="text-xl font-semibold mb-4">Shift Change Requests</h2>
                     <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Requester</th><th class="p-3">Colleague</th><th class="p-3">Date</th><th class="p-3">Shift Change</th><th class="p-3">Remarks</th><th class="p-3">Engineer Comment</th><th class="p-3">Admin Comment</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-requests-body"></tbody></table></div>
                </div>
                <div id="admin-pp-requests-view" class="hidden">
                     <h2 class="text-xl font-semibold mb-4">PP Requests</h2>
                     <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Name</th><th class="p-3">Date</th><th class="p-3">Remarks</th><th class="p-3">Engineer Comment</th><th class="p-3">Admin Comment</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-pp-requests-body"></tbody></table></div>
                </div>
                <div id="admin-coff-requests-view" class="hidden">
                    <h2 class="text-xl font-semibold mb-4">C/Off Requests</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Employee</th><th class="p-3">Avail Date</th><th class="p-3">Earned On</th><th class="p-3">Remarks</th><th class="p-3">Engineer Comment</th><th class="p-3">Admin Comment</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-coff-requests-body"></tbody></table></div>
                </div>
                <div id="admin-leave-requests-view" class="hidden">
                    <h2 class="text-xl font-semibold mb-4">Leave Requests</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Employee</th><th class="p-3">From</th><th class="p-3">To</th><th class="p-3">Days</th><th class="p-3">Reason</th><th class="p-3">Engineer Comment</th><th class="p-3">Admin Comment</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-leave-requests-body"></tbody></table></div>
                </div>
            </div>

            <!-- Employee View -->
            <div id="employee-actions-section" class="card-gradient rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Actions</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="clock-in-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-400">Clock In</button>
                    <button id="clock-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-400">Clock Out</button>
                    <button id="shift-change-request-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Shift Change</button>
                    <button id="pp-request-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg">Apply for PP</button>
                    <button id="coff-request-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">Apply for C/Off</button>
                    <button id="leave-request-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg">Apply for Leave</button>
                </div>
                 <p id="location-status" class="mt-4 text-sm text-gray-600"></p>
            </div>
            <div id="employee-data-section" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card-gradient rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">My Attendance</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Date</th><th class="p-3">In</th><th class="p-3">Out</th><th class="p-3">Hours</th></tr></thead><tbody id="employee-table-body"></tbody></table></div>
                </div>
                <div class="card-gradient rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">My Requests</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-200"><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Details</th><th class="p-3">Status</th><th class="p-3">Comment</th></tr></thead><tbody id="employee-requests-body"></tbody></table></div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, updateDoc, setDoc, deleteDoc, getDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCEVg46yTI80gR-nlsf_T6_3HUtEi77Hj8",
            authDomain: "firstapp-cae0a.firebaseapp.com",
            projectId: "firstapp-cae0a",
            storageBucket: "firstapp-cae0a.appspot.com",
            messagingSenderId: "48434901520",
            appId: "1:48434901520:web:dada602a58d99405505095",
            measurementId: "G-GC63DF4N8G"
        };
        const ADMIN_UID = 'LZC3oe3qOMQnGEN3FGppJIRyO462';
        const ENGINEER_UIDS = ['I14JL1kidHfhRTiFHcBw5YdtlNH2', '103BiCUsRThS2i610GMvMog9Wj22'];
        const OFFICE_LOCATION = { latitude: 28.530243, longitude: 77.357587 };
        const GEOFENCE_RADIUS_METERS = 500;

        // --- DOM ELEMENT REFERENCES ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const userInfo = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const locationStatus = document.getElementById('location-status');
        const employeeTableBody = document.getElementById('employee-table-body');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminTableBody = document.getElementById('admin-table-body');
        const filterDate = document.getElementById('filter-date');
        const filterName = document.getElementById('filter-name');
        const exportBtn = document.getElementById('export-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const monthlyReportBtn = document.getElementById('monthly-report-btn');
        const monthlyReportModal = document.getElementById('monthly-report-modal');
        const monthlyReportForm = document.getElementById('monthly-report-form');
        const cancelMonthlyReportBtn = document.getElementById('cancel-monthly-report-btn');
        const setWeekOffBtn = document.getElementById('set-week-off-btn');
        const weekOffModal = document.getElementById('week-off-modal');
        const weekOffForm = document.getElementById('week-off-form');
        const cancelWeekOffBtn = document.getElementById('cancel-week-off-btn');
        const loadEmployeesBtn = document.getElementById('load-employees-btn');
        const weekOffEmployeeList = document.getElementById('week-off-employee-list');
        const setHolidaysBtn = document.getElementById('set-holidays-btn');
        const holidaysModal = document.getElementById('holidays-modal');
        const holidaysForm = document.getElementById('holidays-form');
        const holidaysMonthInput = document.getElementById('holidays-month');
        const holidaysList = document.getElementById('holidays-list');
        const cancelHolidaysBtn = document.getElementById('cancel-holidays-btn');
        const employeeRequestsBody = document.getElementById('employee-requests-body');
        const termsModal = document.getElementById('terms-modal');
        const acceptTermsBtn = document.getElementById('accept-terms-btn');
        const employeeActionsSection = document.getElementById('employee-actions-section');
        const employeeDataSection = document.getElementById('employee-data-section');
        const onDutySupervisorElement = document.getElementById('on-duty-supervisor');
        const manualCoffModal = document.getElementById('manual-coff-modal');
        const addManualCoffBtn = document.getElementById('add-manual-coff-btn');
        const cancelManualCoffBtn = document.getElementById('cancel-manual-coff-btn');
        const manualCoffForm = document.getElementById('manual-coff-form');
        const bulkPresentModal = document.getElementById('bulk-present-modal');
        const bulkPresentBtn = document.getElementById('bulk-present-btn');
        const cancelBulkPresentBtn = document.getElementById('cancel-bulk-present-btn');
        const bulkPresentForm = document.getElementById('bulk-present-form');
        const bulkEmployeeList = document.getElementById('bulk-employee-list');
        
        const requestForms = {
            shift: { btn: document.getElementById('shift-change-request-btn'), modal: document.getElementById('shift-change-modal'), form: document.getElementById('shift-change-form'), collection: 'shift_requests' },
            pp: { btn: document.getElementById('pp-request-btn'), modal: document.getElementById('pp-request-modal'), form: document.getElementById('pp-request-form'), collection: 'pp_requests' },
            coff: { btn: document.getElementById('coff-request-btn'), modal: document.getElementById('coff-request-modal'), form: document.getElementById('coff-request-form'), collection: 'coff_requests' },
            leave: { btn: document.getElementById('leave-request-btn'), modal: document.getElementById('leave-request-modal'), form: document.getElementById('leave-request-form'), collection: 'leave_requests' },
        };
        const adminViews = {
            attendance: { tab: document.getElementById('tab-attendance'), view: document.getElementById('admin-attendance-view') },
            shift: { tab: document.getElementById('tab-shift-requests'), view: document.getElementById('admin-shift-requests-view'), table: document.getElementById('admin-requests-body'), counter: document.getElementById('shift-request-counter'), collection: 'shift_requests', dashboardCounterId: 'dashboard-shift-request-count' },
            pp: { tab: document.getElementById('tab-pp-requests'), view: document.getElementById('admin-pp-requests-view'), table: document.getElementById('admin-pp-requests-body'), counter: document.getElementById('pp-request-counter'), collection: 'pp_requests', dashboardCounterId: 'dashboard-pp-request-count'},
            coff: { tab: document.getElementById('tab-coff-requests'), view: document.getElementById('admin-coff-requests-view'), table: document.getElementById('admin-coff-requests-body'), counter: document.getElementById('coff-request-counter'), collection: 'coff_requests', dashboardCounterId: 'dashboard-coff-request-count'},
            leave: { tab: document.getElementById('tab-leave-requests'), view: document.getElementById('admin-leave-requests-view'), table: document.getElementById('admin-leave-requests-body'), counter: document.getElementById('leave-request-counter'), collection: 'leave_requests', dashboardCounterId: 'dashboard-leave-request-count'},
        };

        let currentUser = null;
        let allUnsubscribes = [];
        let allUsers = [];
        let allAdminRecords = [];
        let docIdToDelete = null;

        // --- UTILITY FUNCTIONS ---
        const showMessage = (message) => { document.getElementById('message-text').textContent = message; document.getElementById('message-modal').classList.remove('hidden'); };
        const toggleLoader = (show) => loadingOverlay.classList.toggle('hidden', !show);
        const getDistance = (loc1, loc2) => {
            const R = 6371e3;
            const φ1 = loc1.latitude * Math.PI / 180, φ2 = loc2.latitude * Math.PI / 180;
            const Δλ = (loc2.longitude - loc1.longitude) * Math.PI / 180;
            return Math.acos(Math.sin(φ1) * Math.sin(φ2) + Math.cos(φ1) * Math.cos(φ2) * Math.cos(Δλ)) * R;
        };
        const checkLocation = () => new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject("Geolocation Not Supported");
            locationStatus.textContent = "Fetching location...";
            navigator.geolocation.getCurrentPosition(pos => {
                const userLoc = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                const distance = getDistance(userLoc, OFFICE_LOCATION);
                if (distance <= GEOFENCE_RADIUS_METERS) {
                    locationStatus.textContent = "Status: You are within the office location.";
                    resolve("Within Location");
                } else {
                    locationStatus.textContent = `Error: Outside office radius (${distance.toFixed(0)}m away).`;
                    reject(`You are outside the allowed radius.`);
                }
            }, () => reject("Location permission denied."));
        });
        const formatTime = (date) => date ? date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '';
        const formatTimeForInput = (date) => date ? date.toTimeString().slice(0, 5) : '';
        const formatDate = (date) => date.toISOString().split('T')[0];
        const calculateTotalHours = (inTime, outTime) => {
            if (!inTime || !outTime) return "N/A";
            const diffMs = outTime - inTime;
            if (diffMs < 0) return "Invalid";
            return `${String(Math.floor(diffMs / 3600000)).padStart(2, '0')}:${String(Math.round((diffMs % 3600000) / 60000)).padStart(2, '0')}`;
        };
        const getStatusBadge = (status) => {
            const colors = { approved: 'green', rejected: 'red', pending_admin: 'blue', pending_engineer: 'yellow' };
            const statusKey = status || 'pending_engineer';
            const text = statusKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${colors[statusKey]}-100 text-${colors[statusKey]}-800">${text}</span>`;
        };

        // --- FIREBASE INITIALIZATION & APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            toggleLoader(false);
            if (localStorage.getItem('termsAccepted') === 'true') {
                authSection.classList.remove('hidden');
            } else {
                termsModal.classList.remove('hidden');
            }
        });
        acceptTermsBtn.addEventListener('click', () => {
            localStorage.setItem('termsAccepted', 'true');
            termsModal.classList.add('hidden');
            authSection.classList.remove('hidden');
        });

        onAuthStateChanged(auth, async (user) => {
            allUnsubscribes.forEach(unsub => unsub());
            allUnsubscribes = [];
            
            if (user && !user.isAnonymous) {
                currentUser = user;
                const userDocSnap = await getDoc(doc(db, "users", user.uid));
                currentUser.displayName = userDocSnap.exists() ? userDocSnap.data().name : user.email;
                currentUser.empId = userDocSnap.exists() ? userDocSnap.data().empId : '';
                
                userInfo.textContent = `Welcome, ${currentUser.displayName}`;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');

                currentUser.is_admin = user.uid === ADMIN_UID;
                currentUser.is_engineer = ENGINEER_UIDS.includes(user.uid);
                
                await fetchAllUsers();

                if (currentUser.is_admin || currentUser.is_engineer) {
                    adminDashboard.classList.remove('hidden');
                    employeeActionsSection.classList.add('hidden');
                    employeeDataSection.classList.add('hidden');
                    
                    allUnsubscribes.push(listenForAdminRecords(currentUser.is_admin));
                    Object.keys(adminViews).filter(k => k !== 'attendance').forEach(key => {
                        const { table, counter, collection } = adminViews[key];
                        allUnsubscribes.push(createAdminRequestListener(collection, table, counter, key));
                    });
                    [monthlyReportBtn, setHolidaysBtn, setWeekOffBtn, addManualCoffBtn, bulkPresentBtn].forEach(btn => btn.classList.toggle('hidden', !currentUser.is_admin));
                } else {
                    adminDashboard.classList.add('hidden');
                    employeeActionsSection.classList.remove('hidden');
                    employeeDataSection.classList.remove('hidden');
                    allUnsubscribes.push(listenForUserRecords(user.uid), listenForUserRequests(user.uid));
                }
                updateOnDutySupervisor();
                setInterval(updateOnDutySupervisor, 60000);
            } else {
                currentUser = null;
                appContent.classList.add('hidden');
                authSection.classList.remove('hidden');
            }
            toggleLoader(false);
        });

        // --- AUTH FORMS ---
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('auth-container').classList.add('hidden'); document.getElementById('signup-container').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-container').classList.add('hidden'); document.getElementById('auth-container').classList.remove('hidden'); });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            try { await signInWithEmailAndPassword(auth, loginForm.elements['login-email'].value, loginForm.elements['login-password'].value); }
            catch (error) { showMessage(error.message); }
            finally { toggleLoader(false); }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const [name, email, empId, designation, department, orgId, password] = ['signup-name', 'signup-email', 'signup-empid', 'signup-designation', 'signup-department', 'signup-orgid', 'signup-password'].map(id => document.getElementById(id).value);
            
            if (!department) return showMessage("Please select a department.");
            if (orgId !== `AN01${empId}`) return showMessage("Invalid Organization ID.");
            
            toggleLoader(true);
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), { 
                    uid: cred.user.uid, 
                    name, 
                    email, 
                    empId, 
                    designation, 
                    department 
                });
            } catch (error) { showMessage(error.message); }
            finally { toggleLoader(false); }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // --- CORE FUNCTIONALITY (Clock In/Out) ---
        async function updateClockButtons(uid) {
            const q = query(collection(db, "attendance"), where("uid", "==", uid), where("out_time", "==", null));
            const snapshot = await getDocs(q);
            clockInBtn.disabled = !snapshot.empty;
            clockOutBtn.disabled = snapshot.empty;
        }
        clockInBtn.addEventListener('click', async () => {
            toggleLoader(true);
            try {
                if (!(await getDocs(query(collection(db, "attendance"), where("uid", "==", currentUser.uid), where("out_time", "==", null)))).empty) {
                    throw new Error("You have a pending clock-out from a previous day.");
                }
                const location = await checkLocation();
                const now = new Date(), dateStr = formatDate(now), year = now.getFullYear(), month = now.getMonth() + 1, day = now.getDate();

                const weekOffDoc = await getDoc(doc(db, 'weekoffs', `${currentUser.uid}_${year}_${month}`));
                const holidayDoc = await getDoc(doc(db, 'holidays', `${year}-${month}`));
                const isWeekOff = weekOffDoc.exists() && weekOffDoc.data().dates.includes(day);
                const isHoliday = holidayDoc.exists() && holidayDoc.data().dates.includes(day);

                if (isWeekOff || isHoliday) {
                    await addDoc(collection(db, 'coffs'), { uid: currentUser.uid, name: currentUser.displayName, earned_date: dateStr, status: 'earned' });
                    showMessage(`C/off generated for working on a ${isWeekOff ? 'week off' : 'holiday'}.`);
                }
                
                await addDoc(collection(db, "attendance"), { 
                    uid: currentUser.uid, 
                    employee_name: currentUser.displayName, 
                    date: dateStr, 
                    in_time: now, 
                    in_location: location, 
                    out_time: null
                });
                showMessage("Successfully clocked in!");
            } catch (error) { showMessage(`Clock-in failed: ${error.message || error}`); }
            finally { toggleLoader(false); }
        });
        clockOutBtn.addEventListener('click', async () => {
            toggleLoader(true);
            try {
                const location = await checkLocation();
                const now = new Date();
                const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid), where("out_time", "==", null));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error("No open clock-in record found.");
                const docToUpdate = snapshot.docs[0];
                await updateDoc(docToUpdate.ref, { out_time: now, out_location: location, total_hours: calculateTotalHours(docToUpdate.data().in_time.toDate(), now) });
                showMessage("Successfully clocked out!");
            } catch (error) { showMessage(`Clock-out failed: ${error.message || error}`); }
            finally { toggleLoader(false); }
        });

        // --- EMPLOYEE-SPECIFIC LISTENERS ---
        function listenForUserRecords(uid) {
            const q = query(collection(db, "attendance"), where("uid", "==", uid));
            return onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                records.sort((a,b) => (b.in_time?.toDate() || 0) - (a.in_time?.toDate() || 0));
                employeeTableBody.innerHTML = records.map(rec => `<tr><td class="p-3">${rec.date}</td><td class="p-3">${formatTime(rec.in_time?.toDate())}</td><td class="p-3">${formatTime(rec.out_time?.toDate())}</td><td class="p-3">${rec.total_hours || 'N/A'}</td></tr>`).join('') || `<tr><td colspan="4" class="p-4 text-center">No records found.</td></tr>`;
                updateClockButtons(uid);
            }, (error) => { console.error("User records listener failed:", error); showMessage("Could not load your records."); });
        }
        function listenForUserRequests(uid) {
            const collections = ['shift_requests', 'pp_requests', 'coff_requests', 'leave_requests'];
            let allRequests = [];
            const unsubscribes = collections.map(coll => {
                const q = query(collection(db, coll), where("requester_uid", "==", uid));
                return onSnapshot(q, snapshot => {
                    const type = coll.split('_')[0];
                    allRequests = allRequests.filter(r => r.type !== type);
                    snapshot.forEach(d => allRequests.push({ ...d.data(), type }));
                    
                    allRequests.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                    employeeRequestsBody.innerHTML = allRequests.map(req => {
                        let date, details;
                        const comment = req.admin_comment || req.engineer_comment || 'N/A';
                        if (req.type === 'shift') { date = req.change_date; details = `With ${req.colleague_name} (${req.requester_shift}↔${req.colleague_shift})`; }
                        else if (req.type === 'pp') { date = req.request_date; details = req.remarks; }
                        else if (req.type === 'coff') { date = req.avail_date; details = `For C/Off earned on ${req.earned_date}`; }
                        else if (req.type === 'leave') { 
                            date = req.start_date || req.startDate; 
                            details = `${req.total_days} days until ${req.end_date || req.endDate}`; 
                        }
                        return `<tr><td class="p-3">${date}</td><td class="p-3 uppercase font-semibold text-xs">${req.type}</td><td class="p-3">${details || ''}</td><td class="p-3">${getStatusBadge(req.status)}</td><td class="p-3 text-sm">${comment}</td></tr>`;
                    }).join('') || `<tr><td colspan="5" class="p-4 text-center">No requests found.</td></tr>`;
                });
            });
            return () => unsubscribes.forEach(unsub => unsub());
        }

        // --- ADMIN/ENGINEER LISTENERS & VIEWS ---
        async function fetchAllUsers() {
            try {
                allUsers = (await getDocs(collection(db, 'users'))).docs.map(d => ({ id: d.id, ...d.data(), uid: d.id }));
            } catch (error) { console.error("Failed to fetch users:", error); }
        }
        function listenForAdminRecords(isFullAdmin) {
            return onSnapshot(query(collection(db, "attendance")), snapshot => {
                allAdminRecords = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                applyAdminFilters(isFullAdmin);
                updateShiftSummary();
                updateDepartmentSummary();
                updateOnDutySupervisor();
            }, (error) => { console.error("Admin records listener failed:", error); showMessage("Could not load attendance records."); });
        }

        function applyAdminFilters(isFullAdmin) {
            const dateVal = filterDate.value, nameVal = filterName.value.toLowerCase();
            const filtered = allAdminRecords.filter(r => (!dateVal || r.date === dateVal) && (!nameVal || (r.employee_name||'').toLowerCase().includes(nameVal)));
            filtered.sort((a,b) => (b.in_time?.toDate() || 0) - (a.in_time?.toDate() || 0));
            adminTableBody.innerHTML = filtered.map(rec => {
                const user = allUsers.find(u => u.uid === rec.uid);
                const designation = (user && user.designation) ? user.designation : 'N/A';
                return `<tr>
                            <td class="p-3">${rec.date}</td>
                            <td class="p-3 font-medium">${rec.employee_name||'N/A'}</td>
                            <td class="p-3">${designation}</td>
                            <td class="p-3">${formatTime(rec.in_time?.toDate())}</td>
                            <td class="p-3">${formatTime(rec.out_time?.toDate())}</td>
                            <td class="p-3">${rec.total_hours || 'N/A'}</td>
                            <td class="p-3">${isFullAdmin ? `<button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm" data-id="${rec.id}">Edit</button><button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm" data-id="${rec.id}">Delete</button>` : ''}</td>
                        </tr>`;
            }).join('') || `<tr><td colspan="7" class="p-4 text-center">No records found.</td></tr>`;
        }
        [filterDate, filterName].forEach(el => el.addEventListener('input', () => applyAdminFilters(currentUser.is_admin)));

        function createAdminRequestListener(collectionName, tableBody, counterElement, type) {
            const { dashboardCounterId } = adminViews[type];
            return onSnapshot(query(collection(db, collectionName)), (snapshot) => {
                const allRequests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allRequests.sort((a, b) => (b.timestamp?.toDate()?.getTime() || 0) - (a.timestamp?.toDate()?.getTime() || 0));

                const pendingCount = allRequests.filter(req =>
                    (currentUser.is_engineer && !currentUser.is_admin && req.status === 'pending_engineer') ||
                    (currentUser.is_admin && req.status === 'pending_admin')
                ).length;
                
                counterElement.classList.toggle('hidden', pendingCount === 0);
                if (dashboardCounterId) {
                    const dashboardCounterElement = document.getElementById(dashboardCounterId);
                    if(dashboardCounterElement) dashboardCounterElement.textContent = pendingCount;
                }

                tableBody.innerHTML = allRequests.map(req => {
                    let actions = 'N/A';
                    if ((currentUser.is_engineer && !currentUser.is_admin && req.status === 'pending_engineer') || (currentUser.is_admin && req.status === 'pending_admin')) {
                        actions = `<button class="approve-btn bg-green-500 text-white px-2 py-1 rounded-md text-sm" data-id="${req.id}" data-type="${type}" data-coll="${collectionName}">Approve</button>
                                   <button class="reject-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm" data-id="${req.id}" data-type="${type}" data-coll="${collectionName}">Reject</button>`;
                    }
                    
                    let cells = '';
                    let adminCommentCell = `<td class="p-3">${req.admin_comment || 'N/A'}</td>`;
                    let colspan = 10;

                    if (type === 'shift') { cells = `<td class="p-3">${req.requester_name}</td><td class="p-3">${req.colleague_name}</td><td class="p-3">${req.change_date}</td><td class="p-3">${req.requester_shift}↔${req.colleague_shift}</td><td class="p-3">${req.remarks}</td><td class="p-3">${req.engineer_comment || 'N/A'}</td>`; }
                    else if (type === 'pp') { cells = `<td class="p-3">${req.requester_name}</td><td class="p-3">${req.request_date}</td><td class="p-3">${req.remarks}</td><td class="p-3">${req.engineer_comment || 'N/A'}</td>`; colspan = 8; }
                    else if (type === 'coff') { cells = `<td class="p-3">${req.requester_name}</td><td class="p-3">${req.avail_date}</td><td class="p-3">${req.earned_date}</td><td class="p-3">${req.remarks}</td><td class="p-3">${req.engineer_comment || 'N/A'}</td>`; colspan = 9; }
                    else if (type === 'leave') { cells = `<td class="p-3">${req.requester_name}</td><td class="p-3">${req.start_date || req.startDate}</td><td class="p-3">${req.end_date || req.endDate}</td><td class="p-3 text-center">${req.total_days}</td><td class="p-3">${req.reason}</td><td class="p-3">${req.engineer_comment || 'N/A'}</td>`; }
                    
                    return `<tr>${cells}${adminCommentCell}<td class="p-3">${getStatusBadge(req.status)}</td><td class="p-3 space-x-2">${actions}</td></tr>`;
                }).join('') || `<tr><td colspan="${colspan}" class="p-4 text-center">No requests found.</td></tr>`;
            }, (error) => { console.error(`Listener for ${collectionName} failed:`, error); showMessage(`Could not load ${type} requests.`); });
        }
        
        async function handleApprovalClick(e) {
            const { id, type, coll } = e.target.dataset;
            if (!id) return;
            const isApprove = e.target.classList.contains('approve-btn');
            const comment = prompt(`Enter comment for ${isApprove ? 'approval' : 'rejection'}:`);
            if (comment === null) return;
            
            toggleLoader(true);
            const requestRef = doc(db, coll, id);
            let updateData = {};
            
            if (currentUser.is_engineer) {
                updateData.engineer_comment = comment;
                updateData.status = isApprove ? 'pending_admin' : 'rejected';
            } else if (currentUser.is_admin) {
                updateData.admin_comment = comment;
                updateData.status = isApprove ? 'approved' : 'rejected';
            }

            try {
                if (isApprove && currentUser.is_admin && type === 'coff') {
                    const reqDoc = await getDoc(requestRef);
                    const { earned_coff_doc_id, avail_date } = reqDoc.data();
                    const batch = writeBatch(db);
                    batch.update(requestRef, updateData);
                    batch.update(doc(db, 'coffs', earned_coff_doc_id), { status: 'availed', availed_date: avail_date });
                    await batch.commit();
                } else {
                    await updateDoc(requestRef, updateData);
                }
                showMessage(`Request has been processed.`);
            } catch(err) { showMessage(`Error: ${err.message}`); }
            finally { toggleLoader(false); }
        }
        Object.values(adminViews).filter(v => v.table).forEach(v => v.table.addEventListener('click', e => e.target.tagName === 'BUTTON' && handleApprovalClick(e)));

        // --- EMPLOYEE REQUEST FORM HANDLING ---
        Object.values(requestForms).forEach(({ btn, modal, form }) => {
            btn.addEventListener('click', () => { form.reset(); modal.classList.remove('hidden'); });
            form.querySelector('button[type="button"]').addEventListener('click', () => modal.classList.add('hidden'));
        });

        requestForms.shift.btn.addEventListener('click', () => document.getElementById('shift-change-date').valueAsDate = new Date());
        requestForms.pp.btn.addEventListener('click', () => document.getElementById('pp-request-date').valueAsDate = new Date());
        requestForms.coff.btn.addEventListener('click', async () => {
            toggleLoader(true);
            const q = query(collection(db, 'coffs'), where("uid", "==", currentUser.uid), where("status", "==", "earned"));
            const snapshot = await getDocs(q);
            const hasCoff = !snapshot.empty;
            const select = document.getElementById('coff-earned-select');
            select.innerHTML = snapshot.docs.map(d => `<option value="${d.id}" data-earned-date="${d.data().earned_date}">C/Off from ${d.data().earned_date}</option>`).join('');
            document.getElementById('no-coff-message').classList.toggle('hidden', hasCoff);
            select.classList.toggle('hidden', !hasCoff);
            requestForms.coff.form.querySelector('button[type="submit"]').disabled = !hasCoff;
            document.getElementById('coff-avail-date').valueAsDate = new Date();
            toggleLoader(false);
        });

        const leaveStartDate = document.getElementById('leave-start-date');
        const leaveEndDate = document.getElementById('leave-end-date');
        const calculateLeaveDays = () => {
            const start = new Date(leaveStartDate.value), end = new Date(leaveEndDate.value);
            if (!start.getTime() || !end.getTime() || end < start) return 0;
            return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        };
        [leaveStartDate, leaveEndDate].forEach(el => el.addEventListener('change', () => document.getElementById('leave-total-days').textContent = calculateLeaveDays()));
        document.getElementById('leave-terms-ack').addEventListener('change', (e) => document.getElementById('submit-leave-request-btn').disabled = !e.target.checked);
        requestForms.leave.btn.addEventListener('click', () => {
            leaveStartDate.valueAsDate = new Date();
            leaveEndDate.valueAsDate = new Date();
            document.getElementById('leave-total-days').textContent = '1';
        });

        // Universal Form Submission Handler
        document.getElementById('app').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formInfo = Object.values(requestForms).find(f => f.form === form);
            if (!formInfo) return;

            toggleLoader(true);
            const formData = new FormData(form);
            const requestData = { requester_uid: currentUser.uid, requester_name: currentUser.displayName, status: 'pending_engineer', engineer_comment: '', admin_comment: '', timestamp: Timestamp.now() };
            for(let [key, value] of formData.entries()) { requestData[key] = value; }

            try {
                if(formInfo.collection === 'shift_requests'){
                    const colleague = allUsers.find(u => u.empId === requestData.colleague_empid);
                    if (!colleague) throw new Error("Colleague ID not found.");
                    if (colleague.uid === currentUser.uid) throw new Error("Cannot request with yourself.");
                    requestData.colleague_uid = colleague.uid;
                    requestData.colleague_name = colleague.name;
                }
                if (formInfo.collection === 'leave_requests') {
                    if (!document.getElementById('leave-terms-ack').checked) throw new Error("You must acknowledge the terms.");
                    requestData.total_days = calculateLeaveDays();
                    if(requestData.total_days <= 0) throw new Error("Invalid date range.");
                }
                 if(formInfo.collection === 'coff_requests') {
                    const selectedOption = document.getElementById('coff-earned-select').options[document.getElementById('coff-earned-select').selectedIndex];
                    requestData.earned_coff_doc_id = selectedOption.value;
                    requestData.earned_date = selectedOption.dataset.earnedDate;
                }
                
                await addDoc(collection(db, formInfo.collection), requestData);
                showMessage("Request submitted successfully.");
                formInfo.modal.classList.add('hidden');
            } catch(err) { showMessage("Error: " + err.message); } 
            finally { toggleLoader(false); }
        });

        // --- ADMIN CONTROLS (Edit, Delete, Reports, etc.) ---
        adminTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(db, 'attendance', e.target.dataset.id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editForm.elements['edit-doc-id'].value = docSnap.id;
                    editForm.elements['edit-date'].value = data.date;
                    editForm.elements['edit-in-time'].value = formatTimeForInput(data.in_time?.toDate());
                    editForm.elements['edit-out-time'].value = formatTimeForInput(data.out_time?.toDate());
                    editModal.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                docIdToDelete = e.target.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
            }
        });
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        editForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            toggleLoader(true);
            const { value: id } = editForm.elements['edit-doc-id'];
            const { value: newDate } = editForm.elements['edit-date'];
            const inTime = new Date(`${newDate}T${editForm.elements['edit-in-time'].value}`);
            const outTime = editForm.elements['edit-out-time'].value ? new Date(`${newDate}T${editForm.elements['edit-out-time'].value}`) : null;
            await updateDoc(doc(db, 'attendance', id), { date: newDate, in_time: inTime, out_time: outTime, total_hours: calculateTotalHours(inTime, outTime) });
            showMessage("Entry updated.");
            editModal.classList.add('hidden');
            toggleLoader(false);
        });
        cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', async () => {
            if (docIdToDelete) {
                toggleLoader(true);
                await deleteDoc(doc(db, 'attendance', docIdToDelete));
                showMessage("Entry deleted.");
                deleteConfirmModal.classList.add('hidden');
                toggleLoader(false);
            }
        });
        
        // --- MANUAL C/OFF LOGIC ---
        addManualCoffBtn.addEventListener('click', () => {
            const employeeSelect = document.getElementById('manual-coff-employee');
            employeeSelect.innerHTML = allUsers.map(user => `<option value="${user.uid}" data-name="${user.name}">${user.name} (${user.empId || ''})</option>`).join('');
            manualCoffModal.classList.remove('hidden');
        });
        cancelManualCoffBtn.addEventListener('click', () => manualCoffModal.classList.add('hidden'));
        manualCoffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const employeeSelect = document.getElementById('manual-coff-employee');
            const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
            const uid = selectedOption.value;
            const name = selectedOption.dataset.name;
            const earnedDate = document.getElementById('manual-coff-date').value;

            if (uid && name && earnedDate) {
                try {
                    await addDoc(collection(db, 'coffs'), { uid, name, earned_date: earnedDate, status: 'earned' });
                    showMessage(`C/Off for ${name} on ${earnedDate} added successfully.`);
                    manualCoffModal.classList.add('hidden');
                } catch (error) { showMessage(`Error: ${error.message}`); }
            } else { showMessage('Please fill all fields.'); }
            toggleLoader(false);
        });
        
        // --- ORIGINAL EXPORT LOGIC ---
        function exportDailyToCSV() {
            const headers = ["Date", "Employee Name", "In Time", "In Location", "Out Time", "Out Location", "Duty Hours"];
            const dataToExport = allAdminRecords.filter(rec => {
                const date = filterDate.value;
                const name = filterName.value.toLowerCase();
                const nameMatch = name ? (rec.employee_name || '').toLowerCase().includes(name) : true;
                const dateMatch = date ? rec.date === date : true;
                return nameMatch && dateMatch;
            });
            const rows = dataToExport.map(rec => [rec.date, `"${rec.employee_name || 'N/A'}"`, rec.in_time ? `"${formatTime(rec.in_time.toDate())}"` : 'N/A', `"${rec.in_location || 'N/A'}"`, rec.out_time ? `"${formatTime(rec.out_time.toDate())}"` : 'N/A', `"${rec.out_location || 'N/A'}"`, `"${rec.total_hours || 'N/A'}"`].join(','));
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `daily_attendance_${formatDate(new Date())}.csv`;
            link.click();
            link.remove();
        }
        exportBtn.addEventListener('click', exportDailyToCSV);

        // --- MONTHLY REPORT LOGIC (CORRECTED) ---
        monthlyReportBtn.addEventListener('click', () => {
            document.getElementById('report-month').valueAsDate = new Date();
            monthlyReportModal.classList.remove('hidden')
        });
        cancelMonthlyReportBtn.addEventListener('click', () => monthlyReportModal.classList.add('hidden'));
        monthlyReportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const monthYear = document.getElementById('report-month').value;
            if(monthYear) {
                const [year, month] = monthYear.split('-');
                exportMonthlyReport(parseInt(year), parseInt(month));
                monthlyReportModal.classList.add('hidden');
            }
        });
        async function exportMonthlyReport(year, month) {
            toggleLoader(true);
            try {
                await fetchAllUsers();

                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && (today.getMonth() + 1) === month;
                const daysInMonth = new Date(year, month, 0).getDate();
                const daysToReport = isCurrentMonth ? today.getDate() : daysInMonth;

                const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
                
                // Fetch all data first
                const attendanceQuery = query(collection(db, 'attendance'), where("date", ">=", startDate), where("date", "<=", endDate));
                const weekOffsQuery = query(collection(db, 'weekoffs'), where("year", "==", year), where("month", "==", month));
                const holidayDocRef = doc(db, 'holidays', `${year}-${month}`);
                const ppQuery = query(collection(db, 'pp_requests'), where("status", "==", "approved"));
                const coffReqQuery = query(collection(db, 'coff_requests'), where("status", "==", "approved"));
                const leaveReqQuery = query(collection(db, 'leave_requests'), where("status", "==", "approved"));

                const [
                    attendanceSnapshot, 
                    weekOffsSnapshot, 
                    holidayDoc, 
                    ppSnapshot, 
                    coffReqSnapshot, 
                    leaveReqSnapshot
                ] = await Promise.all([
                    getDocs(attendanceQuery),
                    getDocs(weekOffsQuery),
                    getDoc(holidayDocRef),
                    getDocs(ppQuery),
                    getDocs(coffReqQuery),
                    getDocs(leaveReqQuery)
                ]);

                // Process all fetched data
                const monthRecords = attendanceSnapshot.docs.map(doc => doc.data());
                
                const monthWeekOffs = {};
                weekOffsSnapshot.forEach(doc => {
                    monthWeekOffs[doc.data().uid] = doc.data().dates || [];
                });
                
                const holidaysInMonth = holidayDoc.exists() ? holidayDoc.data().dates : [];
                
                const approvedPPs = {};
                ppSnapshot.forEach(doc => {
                    const data = doc.data();
                    const requestDate = new Date(data.request_date + 'T00:00:00Z');
                    if (requestDate.getUTCFullYear() === year && (requestDate.getUTCMonth() + 1) === month) {
                        if (!approvedPPs[data.requester_uid]) approvedPPs[data.requester_uid] = {};
                        approvedPPs[data.requester_uid][requestDate.getUTCDate()] = true;
                    }
                });

                const approvedCoffRequests = {};
                coffReqSnapshot.forEach(doc => {
                    const data = doc.data();
                    const availDate = new Date(data.avail_date + 'T00:00:00Z');
                    if (availDate.getUTCFullYear() === year && (availDate.getUTCMonth() + 1) === month) {
                        if (!approvedCoffRequests[data.requester_uid]) approvedCoffRequests[data.requester_uid] = [];
                        approvedCoffRequests[data.requester_uid].push(availDate.getUTCDate());
                    }
                });
                
                const approvedLeaveRequests = {};
                leaveReqSnapshot.forEach(doc => {
                    const data = doc.data();
                    const sDate = new Date((data.start_date || data.startDate) + 'T00:00:00Z');
                    const eDate = new Date((data.end_date || data.endDate) + 'T00:00:00Z');
                    if (sDate.getUTCFullYear() === year && (sDate.getUTCMonth() + 1) === month || eDate.getUTCFullYear() === year && (eDate.getUTCMonth() + 1) === month) {
                       if (!approvedLeaveRequests[data.requester_uid]) approvedLeaveRequests[data.requester_uid] = [];
                       approvedLeaveRequests[data.requester_uid].push({ start: sDate, end: eDate });
                    }
                });

                // Generate report data
                const reportData = {};
                allUsers.forEach(user => {
                    reportData[user.uid] = { name: user.name, empId: user.empId, days: Array(daysInMonth + 1).fill('A') };
                });
                
                monthRecords.forEach(rec => {
                    if (reportData[rec.uid]) {
                        const dayOfMonth = new Date(rec.date + 'T00:00:00Z').getUTCDate();
                        reportData[rec.uid].days[dayOfMonth] = 'P';
                    }
                });

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(Date.UTC(year, month - 1, day));
                    for (const uid in reportData) {
                        let status = reportData[uid].days[day];
                        
                        if (status === 'P' && approvedPPs[uid]?.[day]) { reportData[uid].days[day] = 'PP'; continue; }
                        
                        let isOnLeave = approvedLeaveRequests[uid]?.some(l => currentDate >= l.start && currentDate <= l.end);
                        if (status !== 'P' && status !== 'PP' && isOnLeave) { reportData[uid].days[day] = 'L'; continue; }
                        
                        if (status !== 'P' && status !== 'PP' && approvedCoffRequests[uid]?.includes(day)) { reportData[uid].days[day] = 'CO'; continue; }
                        
                        if (status === 'A' && holidaysInMonth.includes(day)) { reportData[uid].days[day] = 'H'; continue; }
                        
                        if (status === 'A' && (monthWeekOffs[uid] || []).includes(day)) { reportData[uid].days[day] = 'WO'; continue; }
                    }
                }
                
                const headers = ['NAME', 'EMP ID', ...Array.from({ length: daysToReport }, (_, i) => `${i + 1}-${month}-${year}`), 'P', 'PP', 'A', 'WO', 'H', 'CO', 'L', 'TOTAL'];
                const rows = Object.values(reportData).map(emp => {
                    const counts = emp.days.slice(1, daysToReport + 1).reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                    const presentDays = (counts['P'] || 0) + (counts['PP'] || 0) * 2; // Count PP as 2
                    return [`"${emp.name}"`, `"${emp.empId || ''}"`, ...emp.days.slice(1, daysToReport + 1), counts['P'] || 0, counts['PP'] || 0, counts['A'] || 0, counts['WO'] || 0, counts['H'] || 0, counts['CO'] || 0, counts['L'] || 0, presentDays].join(',');
                });

                const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = `monthly_report_${year}_${month}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Failed to generate monthly report:", error);
                showMessage("Error generating report. Check console for details.");
            } finally {
                toggleLoader(false);
            }
        }


        // --- ORIGINAL WEEK OFF & HOLIDAY LOGIC ---
        setWeekOffBtn.addEventListener('click', () => { weekOffModal.classList.remove('hidden'); document.getElementById('week-off-month').valueAsDate = new Date(); weekOffEmployeeList.innerHTML = ''; });
        cancelWeekOffBtn.addEventListener('click', () => weekOffModal.classList.add('hidden'));
        loadEmployeesBtn.addEventListener('click', async () => {
            const monthYear = document.getElementById('week-off-month').value;
            if (!monthYear) return showMessage("Please select a month first.");
            toggleLoader(true);
            const [year, month] = monthYear.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const q = query(collection(db, 'weekoffs'), where("year", "==", year), where("month", "==", month));
            const snapshot = await getDocs(q);
            const existingWeekOffs = {};
            snapshot.forEach(d => existingWeekOffs[d.data().uid] = d.data().dates || []);
            weekOffEmployeeList.innerHTML = allUsers.map(user => {
                const userWeekOffs = existingWeekOffs[user.id] || [];
                const checkboxes = Array.from({length: daysInMonth}, (_, i) => `<label class="inline-flex items-center mr-2"><input type="checkbox" class="form-checkbox h-4 w-4" value="${i+1}" data-uid="${user.id}" ${userWeekOffs.includes(i+1) ? 'checked' : ''}><span class="ml-1 text-sm">${i+1}</span></label>`).join('');
                return `<div class="p-2 border rounded"><p class="font-semibold">${user.name}</p><div class="flex flex-wrap mt-2">${checkboxes}</div></div>`;
            }).join('');
            toggleLoader(false);
        });
        weekOffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const [year, month] = document.getElementById('week-off-month').value.split('-').map(Number);
            const weekOffsByEmployee = {};
            allUsers.forEach(user => weekOffsByEmployee[user.id] = []);
            weekOffEmployeeList.querySelectorAll('input:checked').forEach(cb => weekOffsByEmployee[cb.dataset.uid].push(parseInt(cb.value)));
            
            const batch = writeBatch(db);
            for (const uid in weekOffsByEmployee) {
                batch.set(doc(db, 'weekoffs', `${uid}_${year}_${month}`), { uid, year, month, dates: weekOffsByEmployee[uid] });
            }
            await batch.commit();
            showMessage("Week offs saved successfully!");
            weekOffModal.classList.add('hidden');
            toggleLoader(false);
        });
        setHolidaysBtn.addEventListener('click', () => { holidaysModal.classList.remove('hidden'); holidaysMonthInput.valueAsDate = new Date(); holidaysMonthInput.dispatchEvent(new Event('change')); });
        cancelHolidaysBtn.addEventListener('click', () => holidaysModal.classList.add('hidden'));
        holidaysMonthInput.addEventListener('change', async () => {
            const monthYear = holidaysMonthInput.value;
            if (!monthYear) return;
            toggleLoader(true);
            const [year, month] = monthYear.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const holidayDoc = await getDoc(doc(db, 'holidays', `${year}-${month}`));
            const existingHolidays = holidayDoc.exists() ? holidayDoc.data().dates : [];
            holidaysList.innerHTML = Array.from({length: daysInMonth}, (_, i) => `<label class="inline-flex items-center mr-2 mb-2"><input type="checkbox" class="form-checkbox h-4 w-4" value="${i+1}" ${existingHolidays.includes(i+1) ? 'checked' : ''}><span class="ml-1 text-sm">${i+1}</span></label>`).join('');
            toggleLoader(false);
        });
        holidaysForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            const [year, month] = holidaysMonthInput.value.split('-').map(Number);
            const selectedHolidays = Array.from(holidaysList.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
            await setDoc(doc(db, 'holidays', `${year}-${month}`), { year, month, dates: selectedHolidays });
            showMessage("Holidays saved successfully!");
            holidaysModal.classList.add('hidden');
            toggleLoader(false);
        });
        
        // --- NEW: BULK PRESENT LOGIC ---
        bulkPresentBtn.addEventListener('click', () => {
            bulkEmployeeList.innerHTML = allUsers.map(user => `
                <label class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-4 w-4" value="${user.uid}" data-name="${user.name}">
                    <span class="ml-2 text-sm">${user.name} (${user.empId || 'No ID'})</span>
                </label>
            `).join('');
            bulkPresentForm.reset();
            document.getElementById('bulk-date').valueAsDate = new Date();
            bulkPresentModal.classList.remove('hidden');
        });

        cancelBulkPresentBtn.addEventListener('click', () => {
            bulkPresentModal.classList.add('hidden');
        });

        document.getElementById('bulk-select-all').addEventListener('click', () => {
            bulkEmployeeList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        });

        document.getElementById('bulk-deselect-all').addEventListener('click', () => {
            bulkEmployeeList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        });

        bulkPresentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dateStr = document.getElementById('bulk-date').value;
            const inTimeStr = document.getElementById('bulk-in-time').value;
            const outTimeStr = document.getElementById('bulk-out-time').value;

            if (!dateStr || !inTimeStr || !outTimeStr) {
                return showMessage("Please fill in the date, in time, and out time.");
            }

            const selectedCheckboxes = Array.from(bulkEmployeeList.querySelectorAll('input:checked'));
            if (selectedCheckboxes.length === 0) {
                return showMessage("Please select at least one employee.");
            }

            toggleLoader(true);
            try {
                const batch = writeBatch(db);
                const inTime = new Date(`${dateStr}T${inTimeStr}`);
                const outTime = new Date(`${dateStr}T${outTimeStr}`);
                const totalHours = calculateTotalHours(inTime, outTime);
                
                const uids = selectedCheckboxes.map(cb => cb.value);
                const q = query(collection(db, 'attendance'), where('date', '==', dateStr), where('uid', 'in', uids));
                const existingDocsSnapshot = await getDocs(q);

                // Delete any existing records for these users on this day to prevent duplicates.
                existingDocsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Create the new records
                selectedCheckboxes.forEach(cb => {
                    const newDocRef = doc(collection(db, 'attendance')); // Create ref for a new doc
                    batch.set(newDocRef, {
                        uid: cb.value,
                        employee_name: cb.dataset.name,
                        date: dateStr,
                        in_time: inTime,
                        out_time: outTime,
                        total_hours: totalHours,
                        is_bulk_entry: true
                    });
                });

                await batch.commit();
                showMessage(`Successfully updated attendance for ${selectedCheckboxes.length} employees. Existing entries for this day were overwritten.`);
                bulkPresentModal.classList.add('hidden');
            } catch (error) {
                console.error("Bulk attendance error:", error);
                showMessage(`An error occurred: ${error.message}`);
            } finally {
                toggleLoader(false);
            }
        });


        // --- TAB SWITCHING ---
        Object.values(adminViews).forEach(({tab, view}) => tab.addEventListener('click', () => {
            Object.values(adminViews).forEach(v => {
                v.view.classList.add('hidden');
                v.tab.classList.remove('bg-blue-600', 'text-white');
            });
            view.classList.remove('hidden');
            tab.classList.add('bg-blue-600', 'text-white');
        }));
        adminViews.attendance.tab.click();

        // --- SHIFT & SUPERVISOR SUMMARY ---
        function updateShiftSummary() {
            if (!allAdminRecords.length) return;
            let counts = { A: 0, B: 0, C: 0, G: 0 };
            const activeToday = allAdminRecords.filter(r => r.date === formatDate(new Date()) && r.in_time && !r.out_time);
            
            activeToday.forEach(r => {
                const inTimeMins = r.in_time.toDate().getHours() * 60 + r.in_time.toDate().getMinutes();
                let shift = 'G';

                if (inTimeMins >= 390 && inTimeMins < 810) { 
                    shift = 'A';
                } else if (inTimeMins >= 810 && inTimeMins < 1290) { 
                    shift = 'B';
                } else { 
                    shift = 'C';
                }
                
                if (inTimeMins >= 540 && inTimeMins < 780) {
                     shift = 'G';
                }
                
                counts[shift]++;
            });
            document.getElementById('shift-a-count').textContent = counts.A;
            document.getElementById('shift-b-count').textContent = counts.B;
            document.getElementById('shift-c-count').textContent = counts.C;
            document.getElementById('shift-g-count').textContent = counts.G;
        }

        function updateDepartmentSummary() {
            if (!allAdminRecords.length || !allUsers.length) return;
            
            const departmentCounts = {};
            const activeToday = allAdminRecords.filter(r => r.date === formatDate(new Date()) && r.in_time && !r.out_time);

            activeToday.forEach(record => {
                const user = allUsers.find(u => u.uid === record.uid);
                const department = (user && user.department) ? user.department : "N/A";
                departmentCounts[department] = (departmentCounts[department] || 0) + 1;
            });

            const container = document.getElementById('department-live-counts');
            container.innerHTML = ''; 

            if (Object.keys(departmentCounts).length === 0) {
                container.innerHTML = `<p class="col-span-full text-gray-300">No employees currently clocked in.</p>`;
                return;
            }
            
            Object.keys(departmentCounts).sort().forEach(department => {
                const count = departmentCounts[department];
                const cardHTML = `
                    <div>
                        <p class="text-2xl font-bold">${count}</p>
                        <p class="text-sm text-gray-300">${department}</p>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        function updateOnDutySupervisor() {
            if (currentUser && (currentUser.is_admin || currentUser.is_engineer)) {
                 if (!allAdminRecords.length) {
                    onDutySupervisorElement.textContent = 'On Duty Supervisor: Loading...';
                    return;
                }
                const supervisorNames = ["Rajan tyagi", "Sudhir Singh"];
                const lowerCaseSupervisorNames = supervisorNames.map(name => name.toLowerCase());
                const todayStr = formatDate(new Date());
                const onDutySupervisors = allAdminRecords.filter(record => {
                    const isClockedInToday = record.date === todayStr && record.in_time && !record.out_time;
                    if (!isClockedInToday || !record.employee_name) return false;
                    return lowerCaseSupervisorNames.includes(record.employee_name.trim().toLowerCase());
                });
                const onDutyNames = [...new Set(onDutySupervisors.map(record => record.employee_name))];
                onDutySupervisorElement.textContent = `On Duty Supervisor: ${onDutyNames.length > 0 ? onDutyNames.join(', ') : 'None'}`;
            } else {
                 onDutySupervisorElement.textContent = ''; 
            }
        }
    </script>
</body>
</html>
